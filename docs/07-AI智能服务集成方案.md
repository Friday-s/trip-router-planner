# 旅游线路规划平台设计与实现 - AI智能服务集成方案

> 版本：v1.0
> 更新日期：2026-01-28
> 状态：已验证通过
> 适用范围：MVP阶段推荐引擎实现

---

## 零、定位说明

本文档描述的是 **推荐引擎的AI实现方案**（`AIRecommendationEngine`），是MVP阶段的默认实现。

### 推荐引擎架构

```
RecommendationEngine (接口)
        │
        ├── AIRecommendationEngine      ← 本文档描述（MVP阶段使用）
        │   └── 调用 DeepSeek/Claude/GPT API
        │
        ├── RuleRecommendationEngine    ← v2.0阶段实现
        │   └── 本地规则引擎，详见05-核心算法文档
        │
        └── HybridRecommendationEngine  ← 可选
            └── AI + 规则混合，自动降级
```

### 切换方式

通过配置即可切换推荐引擎，无需修改业务代码：

```yaml
recommendation:
  engine:
    type: ai      # ai / rule / hybrid
```

---

## 一、方案概述

### 1.1 核心思路

采用「高德API + DeepSeek AI」组合方案，实现全自动化的POI数据标注和智能路线推荐。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        智能服务架构                                       │
└─────────────────────────────────────────────────────────────────────────┘

                              用户请求
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           后端服务层                                      │
│                                                                          │
│   ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐  │
│   │   高德地图API     │    │   DeepSeek AI    │    │   业务逻辑层     │  │
│   │                  │    │                  │    │                  │  │
│   │  • POI搜索       │    │  • 智能标注      │    │  • 数据整合      │  │
│   │  • 路线规划      │    │  • 行程生成      │    │  • 结果缓存      │  │
│   │  • 距离计算      │    │  • 个性化推荐    │    │  • 用户管理      │  │
│   └──────────────────┘    └──────────────────┘    └──────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 各服务职责

| 服务 | 职责 | 优势 |
|-----|------|------|
| 高德地图API | 提供准确的地理位置数据、路线计算 | 数据权威、实时准确 |
| DeepSeek AI | 智能理解、个性化推荐、内容生成 | 理解用户意图、生成丰富内容 |
| 业务逻辑层 | 数据整合、缓存管理、流程控制 | 系统可控、性能优化 |

---

## 二、AI智能标注服务

### 2.1 工作流程

```
Step 1: 高德API获取基础数据
        ↓
        输入：城市名称、搜索关键词
        输出：name, location, address, type, rating, photos

Step 2: DeepSeek AI智能标注
        ↓
        输入：景点名称 + 地址 + 高德分类
        输出：area, tags, visit_duration, highlights, tips, suitable_for...

Step 3: 数据合并存储
        ↓
        高德数据 + AI生成数据 = 完整POI数据

Step 4: 存入数据库 + 缓存
```

### 2.2 AI标注Prompt设计

```
你是一个大理旅游专家。我会给你一个景点的基本信息，请你返回该景点的详细标注数据。

输入景点信息：
- 名称：{name}
- 地址：{address}
- 高德分类：{type}

请返回JSON格式，包含以下字段：

{
  "area": "所属区域（古城区/洱海东岸/洱海西岸/喜洲/苍山/双廊/剑川 之一）",
  "primary_tag": "主标签（古镇/自然风光/历史遗迹/民族文化/宗教场所/休闲娱乐 之一）",
  "tags": ["标签数组，2-4个，如：摄影、徒步、亲子、小众、网红打卡"],
  "visit_duration": 游玩时长（分钟，整数）,
  "best_time": "最佳游玩时间",
  "highlights": ["3个主要亮点"],
  "brief": "一句话介绍（30字以内）",
  "tips": "游玩小贴士",
  "suitable_for": ["适合人群，如：情侣、家庭、摄影爱好者"],
  "difficulty": "游玩难度（轻松/适中/有挑战）"
}

只返回JSON，不要其他内容。
```

### 2.3 标注结果示例

**输入**：
```json
{
  "name": "崇圣寺三塔",
  "address": "大理镇三塔公园",
  "type": "风景名胜;寺庙道观"
}
```

**AI输出**：
```json
{
  "area": "古城区",
  "primary_tag": "历史遗迹",
  "tags": ["古迹", "摄影", "历史文化", "地标建筑"],
  "visit_duration": 120,
  "best_time": "上午或傍晚，光线适合拍照",
  "highlights": ["三塔倒影", "崇圣寺", "南诏历史"],
  "brief": "始建于唐代的标志性古塔群，大理最具代表性的历史遗迹",
  "tips": "建议傍晚前往，可拍摄三塔倒影",
  "suitable_for": ["情侣", "摄影爱好者", "历史文化爱好者"],
  "difficulty": "轻松"
}
```

---

## 三、AI智能路线推荐服务

### 3.1 工作流程

```
Step 1: 用户输入偏好
        ↓
        天数、主题、节奏、特殊需求

Step 2: 获取候选POI池
        ↓
        从数据库获取符合主题的POI列表（含AI标注数据）

Step 3: DeepSeek AI生成行程
        ↓
        输入：用户偏好 + 候选POI列表
        输出：分天行程安排（含时间、景点、建议）

Step 4: 高德API补充路线数据
        ↓
        计算各景点间的距离、步行/驾车时间

Step 5: 返回完整行程
```

### 3.2 行程生成Prompt设计

```
你是一个专业的大理旅游行程规划师。请根据用户的需求和以下景点列表，生成一份合理的旅游行程。

用户需求：
- 天数：{days}天
- 主题偏好：{themes}
- 出行节奏：{pace}（轻松/适中/紧凑）
- 出行人群：{travelers}
- 特殊需求：{special_requirements}

可选景点列表：
{poi_list}

请生成行程，返回JSON格式：

{
  "title": "行程标题",
  "summary": "行程概述（50字以内）",
  "days": [
    {
      "day": 1,
      "theme": "当日主题",
      "items": [
        {
          "poi_id": "景点ID",
          "poi_name": "景点名称",
          "start_time": "09:00",
          "duration": 120,
          "tips": "游玩建议"
        }
      ],
      "meals": {
        "lunch": "午餐建议",
        "dinner": "晚餐建议"
      },
      "notes": "当日注意事项"
    }
  ],
  "tips": ["整体行程贴士"],
  "packing_list": ["建议携带物品"]
}

规划原则：
1. 同一天的景点应在相近区域，减少交通时间
2. 每天游玩时间控制在8小时内（轻松6小时、紧凑10小时）
3. 考虑景点的最佳游玩时间（如日出日落）
4. 合理安排用餐时间和休息时间
5. 根据出行人群调整难度和节奏

只返回JSON，不要其他内容。
```

### 3.3 行程生成示例

**用户输入**：
```
- 天数：3天
- 主题：古镇文化、摄影
- 节奏：轻松
- 人群：情侣
```

**AI生成的行程**：
```json
{
  "title": "大理3日浪漫古镇摄影之旅",
  "summary": "漫步白族古镇，捕捉洱海最美光影，感受风花雪月的浪漫",
  "days": [
    {
      "day": 1,
      "theme": "大理古城慢时光",
      "items": [
        {
          "poi_id": "poi_001",
          "poi_name": "大理古城",
          "start_time": "10:00",
          "duration": 180,
          "tips": "从南门进入，沿复兴路漫步，感受白族建筑风情"
        },
        {
          "poi_id": "poi_002",
          "poi_name": "崇圣寺三塔",
          "start_time": "15:00",
          "duration": 120,
          "tips": "傍晚光线最佳，可拍摄三塔倒影"
        }
      ],
      "meals": {
        "lunch": "古城内白族风味餐厅，推荐饵丝、乳扇",
        "dinner": "古城人民路酒吧街附近，边吃边看夜景"
      },
      "notes": "今日以古城为主，不赶时间，慢慢感受"
    },
    {
      "day": 2,
      "theme": "双廊洱海风光",
      "items": [
        {
          "poi_id": "poi_003",
          "poi_name": "双廊古镇",
          "start_time": "09:00",
          "duration": 240,
          "tips": "早起可看洱海日出，玉几岛是必去打卡点"
        },
        {
          "poi_id": "poi_004",
          "poi_name": "南诏风情岛",
          "start_time": "14:00",
          "duration": 120,
          "tips": "岛上有观音像，可俯瞰洱海全景"
        }
      ],
      "meals": {
        "lunch": "双廊古镇海景餐厅，边吃边看洱海",
        "dinner": "双廊特色白族菜"
      },
      "notes": "建议在双廊住一晚，体验洱海日落日出"
    },
    {
      "day": 3,
      "theme": "喜洲田园风光",
      "items": [
        {
          "poi_id": "poi_005",
          "poi_name": "喜洲古镇",
          "start_time": "09:30",
          "duration": 180,
          "tips": "严家大院是最具代表性的白族民居，喜洲粑粑是必尝小吃"
        },
        {
          "poi_id": "poi_006",
          "poi_name": "海舌生态公园",
          "start_time": "14:30",
          "duration": 90,
          "tips": "伸入洱海的半岛，拍照绝佳地点，下午光线好"
        }
      ],
      "meals": {
        "lunch": "喜洲古镇品尝喜洲粑粑和白族八大碗",
        "dinner": "返回大理古城，告别晚餐"
      },
      "notes": "今日较为轻松，可慢慢拍照"
    }
  ],
  "tips": [
    "大理紫外线强，注意防晒",
    "早晚温差大，带件薄外套",
    "雨季出行带好雨具"
  ],
  "packing_list": ["防晒霜", "墨镜", "薄外套", "相机", "充电宝"]
}
```

---

## 四、API集成实现

### 4.1 后端服务设计

```java
@Service
public class AIService {

    @Value("${deepseek.api.key}")
    private String apiKey;

    @Value("${deepseek.api.url}")
    private String apiUrl;

    private final RestTemplate restTemplate;
    private final RedisTemplate<String, Object> redisTemplate;

    /**
     * AI智能标注POI
     */
    public PoiLabel labelPoi(PoiBasicInfo poi) {
        String cacheKey = "poi:label:" + poi.getId();

        // 1. 查缓存
        PoiLabel cached = (PoiLabel) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }

        // 2. 构造Prompt
        String prompt = buildLabelPrompt(poi);

        // 3. 调用DeepSeek API
        String response = callDeepSeekApi(prompt);

        // 4. 解析JSON响应
        PoiLabel label = parsePoiLabel(response);

        // 5. 缓存结果（永久缓存，因为标注数据不变）
        redisTemplate.opsForValue().set(cacheKey, label);

        return label;
    }

    /**
     * AI生成行程
     */
    public ItineraryPlan generateItinerary(GenerateRequest request, List<Poi> candidatePois) {
        // 1. 构造Prompt
        String prompt = buildItineraryPrompt(request, candidatePois);

        // 2. 调用DeepSeek API
        String response = callDeepSeekApi(prompt);

        // 3. 解析JSON响应
        ItineraryPlan plan = parseItineraryPlan(response);

        return plan;
    }

    private String callDeepSeekApi(String prompt) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(apiKey);

        Map<String, Object> body = Map.of(
            "model", "deepseek-chat",
            "messages", List.of(
                Map.of("role", "user", "content", prompt)
            ),
            "temperature", 0.7
        );

        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(body, headers);

        ResponseEntity<Map> response = restTemplate.postForEntity(
            apiUrl + "/chat/completions",
            entity,
            Map.class
        );

        // 提取响应内容
        Map choices = ((List<Map>) response.getBody().get("choices")).get(0);
        Map message = (Map) choices.get("message");
        return (String) message.get("content");
    }
}
```

### 4.2 行程生成完整流程

```java
@Service
public class ItineraryGenerateService {

    private final PoiService poiService;
    private final AIService aiService;
    private final AmapService amapService;

    /**
     * 生成完整行程
     */
    public Itinerary generate(GenerateRequest request) {
        // Step 1: 获取候选POI池
        List<Poi> candidates = poiService.findByThemes(request.getThemes());

        // Step 2: AI生成行程骨架
        ItineraryPlan plan = aiService.generateItinerary(request, candidates);

        // Step 3: 补充路线信息（高德API）
        for (DayPlan day : plan.getDays()) {
            List<ItineraryItem> items = day.getItems();
            for (int i = 0; i < items.size() - 1; i++) {
                Poi from = poiService.getById(items.get(i).getPoiId());
                Poi to = poiService.getById(items.get(i + 1).getPoiId());

                // 计算路线
                RouteLeg leg = amapService.getRoute(
                    from.getLongitude(), from.getLatitude(),
                    to.getLongitude(), to.getLatitude(),
                    request.getTransportMode()
                );

                items.get(i).setRouteLeg(leg);
            }
        }

        // Step 4: 构建并保存行程
        Itinerary itinerary = buildItinerary(request, plan);
        itineraryRepository.save(itinerary);

        return itinerary;
    }
}
```

---

## 五、成本与性能

### 5.1 API成本估算

| 场景 | 调用次数 | Token消耗 | 估算成本 |
|-----|---------|----------|---------|
| 标注50个POI | 50次 | ~25000 token | ¥0.5-1 |
| 生成1个行程 | 1次 | ~2000 token | ¥0.05 |
| 日均100次行程生成 | 100次 | ~200000 token | ¥5 |

**结论：成本极低，完全可接受**

### 5.2 性能优化策略

| 优化点 | 策略 |
|-------|------|
| POI标注 | 批量预处理，结果永久缓存 |
| 行程生成 | 结果缓存1小时（相似请求复用） |
| 高德路线 | 缓存7天（路线数据变化小） |
| 请求超时 | 设置30秒超时，避免阻塞 |

### 5.3 错误处理与降级

```java
public ItineraryPlan generateItinerary(GenerateRequest request, List<Poi> candidates) {
    try {
        return aiService.generateItinerary(request, candidates);
    } catch (Exception e) {
        log.error("AI行程生成失败，降级到规则引擎", e);
        // 降级方案：使用传统算法生成
        return fallbackGenerator.generate(request, candidates);
    }
}
```

---

## 六、配置说明

### 6.1 环境变量

```bash
# DeepSeek API配置
DEEPSEEK_API_KEY=sk-564c8b0b2a7d44e6922131ea381149f5
DEEPSEEK_API_URL=https://api.deepseek.com

# 高德地图配置
AMAP_WEBSERVICE_KEY=487bc586955bc57052a1aee191de4e25
```

### 6.2 application.yml

```yaml
deepseek:
  api:
    key: ${DEEPSEEK_API_KEY}
    url: ${DEEPSEEK_API_URL:https://api.deepseek.com}
    timeout: 30000  # 30秒超时

amap:
  webservice:
    key: ${AMAP_WEBSERVICE_KEY}
    base-url: https://restapi.amap.com/v3
```

---

## 七、验证记录

### 7.1 DeepSeek API验证

**验证日期**：2026-01-27

**测试1：POI智能标注**
- 输入：崇圣寺三塔基础信息
- 输出：完整的标注数据（area、tags、visit_duration等）
- 结果：✓ 通过

**测试2：行程生成（古镇文化主题）**
- 输入：3天，古镇文化主题，轻松节奏
- 输出：分天行程，含景点、时间、建议
- 结果：✓ 通过

**测试3：行程生成（情侣摄影主题）**
- 输入：2天，情侣，摄影，不想太累
- 输出：浪漫摄影行程，含打卡点推荐
- 结果：✓ 通过

### 7.2 高德API验证

**验证日期**：2026-01-27

- 大理景点搜索：返回450个结果 ✓
- 包含热门景点：双廊、喜洲、崇圣寺三塔等 ✓
- 数据质量：有评分、照片、分类信息 ✓

---

## 八、总结

### 8.1 方案优势

1. **全自动化**：无需人工标注，AI自动生成丰富的POI数据
2. **智能推荐**：AI理解用户意图，生成个性化行程
3. **成本极低**：API调用成本可忽略不计
4. **灵活可控**：可随时调整Prompt优化输出质量
5. **可靠降级**：AI失败时可降级到传统算法

### 8.2 实施步骤

1. ✅ 验证高德API可用性
2. ✅ 验证DeepSeek API可用性
3. ✅ 设计Prompt模板
4. ⬜ 实现后端AI服务层
5. ⬜ 批量标注POI数据
6. ⬜ 集成行程生成流程
7. ⬜ 测试与优化
