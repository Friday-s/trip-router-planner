# 开发问题总结与经验教训

> 整理日期：2026-01-28
> 版本范围：v1.0.0 - v1.0.3

---

## 一、问题分类统计

| 类别 | 问题数量 | 占比 |
|------|----------|------|
| 环境配置 | 4 | 44% |
| 数据类型 | 2 | 22% |
| 第三方集成 | 2 | 22% |
| 业务逻辑 | 1 | 11% |

---

## 二、问题详情

### 2.1 环境配置问题

#### 问题1：MySQL Public Key Retrieval
- **版本**：v1.0.1
- **现象**：`Public Key Retrieval is not allowed`
- **原因**：MySQL 8.0+ 使用 `caching_sha2_password` 认证插件
- **解决**：JDBC URL 添加 `allowPublicKeyRetrieval=true`
- **教训**：MySQL 8.0 与旧版本配置有差异，需查阅官方文档

#### 问题2：MySQL 密码配置
- **版本**：v1.0.1
- **现象**：`Access denied for user 'root'@'localhost'`
- **原因**：配置文件默认密码与本地 MySQL 不匹配
- **解决**：修改默认密码为空字符串
- **教训**：使用环境变量管理敏感配置，不硬编码默认值

#### 问题3：BCrypt 密码哈希不匹配
- **版本**：v1.0.1
- **现象**：管理员账号 admin123 无法登录
- **原因**：init-data.sql 中的 BCrypt 哈希值与实际密码不对应
- **解决**：通过注册接口生成正确哈希值，更新数据库
- **教训**：BCrypt 哈希应通过代码生成，不手动编写

#### 问题4：高德地图 API Key 配置错误
- **版本**：v1.0.3
- **现象**：地图无法加载
- **原因**：混淆了 JS API Key 和 Web 服务 Key
- **解决**：区分不同类型的 Key，正确配置
- **教训**：第三方服务通常有多种 Key，需仔细阅读文档

---

### 2.2 数据类型问题

#### 问题5：JSON_CONTAINS 参数绑定
- **版本**：v1.0.1
- **现象**：`Parameter index out of range (3 > number of parameters, which is 2)`
- **原因**：MyBatis-Plus apply() 方法参数占位符语法错误
- **错误写法**：`wrapper.apply("JSON_CONTAINS(tags, '\"{0}\"')", tag)`
- **正确写法**：`wrapper.apply("JSON_CONTAINS(tags, {0})", "\"" + tag + "\"")`
- **教训**：占位符 {0} 会被替换为实际参数，不要在占位符外添加引号

#### 问题6：坐标 BigDecimal 序列化为字符串
- **版本**：v1.0.2
- **现象**：地图只显示标记点标签，底图不渲染
- **原因**：后端 BigDecimal 序列化为 JSON 字符串，高德地图需要数字
- **解决**：前端使用 `parseFloat()` 转换坐标
- **教训**：前后端数据交互需注意类型转换，特别是数字类型

---

### 2.3 第三方集成问题

#### 问题7：高德地图加载方式
- **版本**：v1.0.3
- **现象**：直接 script 标签加载地图不稳定
- **原因**：存在加载时序问题
- **解决**：改用官方推荐的 AMapLoader 动态加载
- **教训**：第三方 SDK 应使用官方推荐的集成方式

#### 问题8：高德地图安全密钥
- **版本**：v1.0.3
- **现象**：地图 API 调用失败
- **原因**：2021年12月后申请的 Key 必须配合安全密钥
- **解决**：配置 `window._AMapSecurityConfig`（必须在 loader.js 之前）
- **教训**：第三方服务可能有时间节点的政策变化，需关注最新文档

---

### 2.4 业务逻辑问题

#### 问题9：管理员登录跳转
- **版本**：v1.0.1
- **现象**：管理员登录后跳转到普通用户首页
- **原因**：登录成功后未区分角色进行跳转
- **解决**：添加角色判断，管理员跳转到 /admin
- **教训**：角色权限功能需要完整的端到端测试

---

## 三、经验教训总结

### 3.1 配置管理
1. **敏感信息使用环境变量**：密码、API Key 等不硬编码
2. **提供合理的默认值**：开发环境可快速启动
3. **文档化配置项**：说明每个配置的用途和获取方式

### 3.2 数据类型
1. **前后端类型约定**：明确坐标等数值类型的传输格式
2. **序列化测试**：BigDecimal、Date 等特殊类型需验证序列化结果
3. **防御性编程**：前端对接口数据做类型校验和转换

### 3.3 第三方集成
1. **阅读官方文档**：使用推荐的集成方式
2. **关注版本变化**：API 可能有时间节点的政策调整
3. **区分不同类型的凭证**：前端 Key、后端 Key、安全密钥各有用途

### 3.4 测试验证
1. **端到端测试**：登录流程需测试到最终页面
2. **边界条件**：空值、类型转换、权限判断
3. **多环境测试**：开发、测试、生产环境配置可能不同

---

## 四、预防措施

### 4.1 开发规范
- [ ] 新增配置项时更新 .env.example
- [ ] 第三方集成需记录 Key 申请流程
- [ ] 数据库初始化脚本需通过代码验证

### 4.2 代码审查
- [ ] 检查敏感信息是否硬编码
- [ ] 检查前后端数据类型是否匹配
- [ ] 检查第三方 SDK 版本和配置

### 4.3 测试清单
- [ ] 数据库连接测试
- [ ] 管理员和普通用户登录测试
- [ ] 地图功能测试（标记、路线、缩放）
- [ ] AI 行程生成测试

---

## 五、相关文档

- [开发指南](../DEVELOPMENT.md) - 包含详细的问题解决方案
- [v1.0.1 更新日志](./v1.0.1.md)
- [v1.0.2 更新日志](./v1.0.2.md)
- [v1.0.3 更新日志](./v1.0.3.md)
