# v1.0.3 地图加载方式优化

> 发布日期：2026-01-28
> 版本类型：Bug修复

---

## 版本概述

修复地图仍无法渲染的问题，改用官方推荐的 AMapLoader 动态加载方式，并添加安全密钥配置。

---

## 修复内容

### 地图无法渲染问题

**问题描述**：
v1.0.2 修复坐标类型后，地图底图仍然无法渲染显示。

**问题原因**：
1. 直接通过 `<script>` 标签加载 AMap API 可能存在加载时序问题
2. **2021年12月后申请的 key 必须配合安全密钥使用**
3. 原方式不是官方推荐的加载方式
4. 使用了错误的 API Key

**修复方案**：
1. 改用高德地图官方推荐的 AMapLoader 动态加载方式
2. 添加安全密钥配置（必须在 loader.js 之前）
3. 更正 JS API Key

**修复代码**：

`frontend/index.html`:
```html
<!-- 高德地图安全密钥配置（必须在 loader.js 之前） -->
<script type="text/javascript">
  window._AMapSecurityConfig = {
    securityJsCode: '7fc8315f03c70f6d095818bf620812e1'
  }
</script>
<!-- 高德地图 JS API Loader -->
<script src="https://webapi.amap.com/loader.js"></script>
```

`frontend/src/views/ItineraryPage.vue`:
```javascript
function initMap() {
  if (!itinerary.value?.mapData) {
    console.error('地图数据不存在')
    return
  }

  // 使用 AMapLoader 动态加载高德地图
  window.AMapLoader.load({
    key: '1bff3863bb0fa284917db902aa91bfa7',  // JS API Key
    version: '2.0',
    plugins: []
  }).then((AMap) => {
    // 初始化地图...
  }).catch((e) => {
    console.error('高德地图加载失败:', e)
  })
}
```

**涉及文件**：
- `frontend/index.html`
- `frontend/src/views/ItineraryPage.vue`

---

## 技术说明

### 高德地图密钥体系

2021年12月02日后申请的 key 需要两个密钥配合使用：

| 密钥类型 | 用途 | 配置位置 |
|----------|------|----------|
| JS API Key | AMapLoader.load() 的 key 参数 | Vue 组件中 |
| 安全密钥 | window._AMapSecurityConfig | index.html（loader.js 之前） |

### AMapLoader 优势

1. **官方推荐**：高德地图官方推荐的加载方式
2. **按需加载**：支持按需加载插件
3. **Promise 接口**：返回 Promise，更好的异步控制
4. **错误处理**：提供完整的错误捕获机制

---

## 测试验证

| 测试项 | 结果 |
|--------|------|
| 地图底图加载 | 待验证 |
| 景点标记点显示 | 待验证 |
| 路线连线显示 | 待验证 |

---

## 涉及文件清单

| 文件 | 修改类型 |
|------|----------|
| frontend/index.html | 修改 |
| frontend/src/views/ItineraryPage.vue | 修改 |
| docs/changelog/v1.0.3.md | 新增 |

---

**提交者**: 开发团队
**审核者**: -
