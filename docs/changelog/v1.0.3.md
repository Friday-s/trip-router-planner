# v1.0.3 地图加载方式优化

> 发布日期：2026-01-28
> 版本类型：Bug修复

---

## 版本概述

修复地图仍无法渲染的问题，改用官方推荐的 AMapLoader 动态加载方式。

---

## 修复内容

### 地图无法渲染问题

**问题描述**：
v1.0.2 修复坐标类型后，地图底图仍然无法渲染显示。

**问题原因**：
1. 直接通过 `<script>` 标签加载 AMap API 可能存在加载时序问题
2. 2021年12月后申请的 key 需要配合安全密钥使用
3. 原方式不是官方推荐的加载方式

**修复方案**：
改用高德地图官方推荐的 AMapLoader 动态加载方式。

**修复代码**：

`frontend/index.html`:
```html
<!-- 使用官方推荐的 JS API Loader -->
<script src="https://webapi.amap.com/loader.js"></script>
```

`frontend/src/views/ItineraryPage.vue`:
```javascript
function initMap() {
  if (!itinerary.value?.mapData) {
    console.error('地图数据不存在')
    return
  }

  // 使用 AMapLoader 动态加载高德地图
  window.AMapLoader.load({
    key: '1bff3863bb0fa284917db902aa91bfa7',  // JS API Key
    version: '2.0',
    plugins: []
  }).then((AMap) => {
    const mapData = itinerary.value.mapData

    // 转换中心点坐标为数字
    const center = mapData.center ? [
      parseFloat(mapData.center[0]),
      parseFloat(mapData.center[1])
    ] : [100.1653, 25.6969]

    map.value = new AMap.Map('amap', {
      zoom: mapData.zoom || 12,
      center: center,
      viewMode: '2D'
    })

    // ... 标记点和路线代码
  }).catch((e) => {
    console.error('高德地图加载失败:', e)
  })
}
```

**涉及文件**：
- `frontend/index.html`
- `frontend/src/views/ItineraryPage.vue`

---

## 技术说明

### AMapLoader 优势

1. **官方推荐**：高德地图官方推荐的加载方式
2. **按需加载**：支持按需加载插件
3. **Promise 接口**：返回 Promise，更好的异步控制
4. **错误处理**：提供完整的错误捕获机制

### 加载流程

```
index.html 加载 loader.js
       ↓
ItineraryPage.vue onMounted
       ↓
调用 AMapLoader.load()
       ↓
Promise 返回 AMap 对象
       ↓
初始化地图、添加标记和路线
```

---

## 测试验证

| 测试项 | 结果 |
|--------|------|
| 地图底图加载 | 待验证 |
| 景点标记点显示 | 待验证 |
| 路线连线显示 | 待验证 |

---

## 涉及文件清单

| 文件 | 修改类型 |
|------|----------|
| frontend/index.html | 修改 |
| frontend/src/views/ItineraryPage.vue | 修改 |
| docs/changelog/v1.0.3.md | 新增 |

---

**提交者**: 开发团队
**审核者**: -
