# v1.0.2 地图显示修复

> 发布日期：2026-01-28
> 版本类型：Bug修复

---

## 版本概述

修复行程详情页地图无法正常显示的问题。

---

## 修复内容

### 地图无法显示问题

**问题描述**：
行程详情页右侧地图区域只显示标记点的标签，但地图底图无法渲染。

**问题原因**：
1. 后端返回的坐标数据为 `BigDecimal` 类型，序列化为JSON后变成字符串（如 `"100.1653000"`）
2. 高德地图API要求坐标必须是数字类型
3. 地图初始化时未对坐标进行类型转换

**修复方案**：
在地图初始化时，将所有坐标数据从字符串转换为数字类型。

**修复代码**：
```javascript
// 转换中心点坐标为数字
const center = mapData.center ? [
  parseFloat(mapData.center[0]),
  parseFloat(mapData.center[1])
] : [100.1653, 25.6969]

// 转换标记点坐标
const position = [
  parseFloat(marker.position[0]),
  parseFloat(marker.position[1])
]

// 转换路径坐标
const path = polyline.path.map(point => [
  parseFloat(point[0]),
  parseFloat(point[1])
])
```

**涉及文件**：
- `frontend/src/views/ItineraryPage.vue`

---

## 优化内容

### 1. 地图初始化时序优化

**优化描述**：
使用 `nextTick` + `setTimeout` 双重保障，确保DOM完全渲染后再初始化地图。

**修改前**：
```javascript
setTimeout(initMap, 100)
```

**修改后**：
```javascript
await nextTick()
setTimeout(initMap, 200)
```

### 2. 地图容器样式优化

**优化描述**：
为地图容器添加最小高度和背景色，确保加载时有明确的占位区域。

**新增样式**：
```scss
.map-container {
  min-height: 400px;
  background: #e4e4e4;
}
```

### 3. 错误日志增强

**优化描述**：
在地图初始化函数中添加详细的错误日志，便于调试。

```javascript
if (!window.AMap) {
  console.error('高德地图API未加载')
  return
}
if (!itinerary.value?.mapData) {
  console.error('地图数据不存在')
  return
}
```

---

## 测试验证

| 测试项 | 结果 |
|--------|------|
| 地图底图加载 | ✅ 通过 |
| 景点标记点显示 | ✅ 通过 |
| 路线连线显示 | ✅ 通过 |
| 地图自适应视野 | ✅ 通过 |
| 不同天数行程地图显示 | ✅ 通过 |

---

## 涉及文件清单

| 文件 | 修改类型 |
|------|----------|
| frontend/src/views/ItineraryPage.vue | 修改 |
| docs/changelog/v1.0.2.md | 新增 |

---

**提交者**: 开发团队
**审核者**: -
