# 大理旅游线路规划平台 - 部署运维文档

> 版本：v1.0
> 更新日期：2026-01-27

---

## 一、环境要求

### 1.1 开发环境

| 组件 | 版本要求 | 说明 |
|-----|---------|------|
| JDK | 17+ | 推荐 Eclipse Temurin |
| Node.js | 18+ | 推荐 LTS 版本 |
| npm/pnpm | 8+/8+ | 包管理器 |
| MySQL | 8.0+ | 数据库 |
| Redis | 7.0+ | 缓存 |
| Git | 2.0+ | 版本控制 |
| IDE | IntelliJ IDEA / VS Code | 开发工具 |

### 1.2 生产环境

| 组件 | 版本要求 | 配置建议 |
|-----|---------|---------|
| Linux | Ubuntu 22.04 / CentOS 8 | - |
| JDK | 17+ | - |
| Nginx | 1.24+ | 反向代理 |
| MySQL | 8.0+ | 2核4G起步 |
| Redis | 7.0+ | 1G内存起步 |
| Docker | 24+ | 可选，容器化部署 |

### 1.3 服务器配置建议

| 环境 | CPU | 内存 | 磁盘 |
|-----|-----|------|------|
| 开发测试 | 2核 | 4G | 50G |
| 生产最小 | 4核 | 8G | 100G |
| 生产推荐 | 8核 | 16G | 200G |

---

## 二、环境变量配置

### 2.1 后端环境变量

创建 `backend/.env` 文件（基于 `.env.example`）：

```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=trip_planner
DB_USER=trip_user
DB_PASSWORD=your_secure_password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your_jwt_secret_key_at_least_32_characters
JWT_EXPIRATION=86400000

# 高德地图配置
AMAP_WEBSERVICE_KEY=487bc586955bc57052a1aee191de4e25

# 应用配置
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=dev
```

### 2.2 前端环境变量

创建 `frontend/.env.local` 文件（基于 `.env.example`）：

```bash
# API地址
VITE_API_BASE_URL=http://localhost:8080/api

# 高德地图JS Key
VITE_AMAP_JS_KEY=your_amap_js_key

# 高德地图安全密钥（可选）
VITE_AMAP_SECURITY_CODE=your_security_code
```

### 2.3 环境变量说明

| 变量 | 说明 | 是否敏感 |
|-----|------|---------|
| DB_PASSWORD | 数据库密码 | 是 |
| JWT_SECRET | JWT签名密钥，至少32字符 | 是 |
| AMAP_WEBSERVICE_KEY | 高德Web服务Key | 是 |
| REDIS_PASSWORD | Redis密码 | 是 |
| VITE_AMAP_JS_KEY | 高德JS Key | 否（需配置域名白名单） |

---

## 三、本地开发环境搭建

### 3.1 克隆项目

```bash
git clone https://github.com/your-org/trip-route-planner.git
cd trip-route-planner
```

### 3.2 数据库初始化

```bash
# 登录MySQL
mysql -u root -p

# 执行建表脚本
source database/schema.sql

# 执行初始数据脚本
source database/init-data.sql

# 创建应用用户
CREATE USER 'trip_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON trip_planner.* TO 'trip_user'@'localhost';
FLUSH PRIVILEGES;
```

### 3.3 启动Redis

```bash
# macOS (Homebrew)
brew services start redis

# Linux
sudo systemctl start redis

# 验证
redis-cli ping
# 应返回: PONG
```

### 3.4 启动后端

```bash
cd backend

# 复制环境变量文件
cp .env.example .env
# 编辑 .env 填入实际配置

# 使用Maven运行
./mvnw spring-boot:run

# 或者先打包再运行
./mvnw clean package -DskipTests
java -jar target/trip-planner-0.0.1-SNAPSHOT.jar
```

后端启动成功后，访问 http://localhost:8080/api/health 应返回 `{"status": "UP"}`

### 3.5 启动前端

```bash
cd frontend

# 安装依赖
npm install
# 或使用 pnpm
pnpm install

# 复制环境变量文件
cp .env.example .env.local
# 编辑 .env.local 填入实际配置

# 启动开发服务器
npm run dev
```

前端启动成功后，访问 http://localhost:5173

---

## 四、生产部署

### 4.1 部署架构

```
                    ┌─────────────────┐
                    │    用户请求      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │     Nginx       │
                    │   (80/443)      │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            ▼                                 ▼
   ┌─────────────────┐              ┌─────────────────┐
   │   静态资源       │              │    /api/*       │
   │  (前端dist)     │              │  反向代理        │
   └─────────────────┘              └────────┬────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  Spring Boot    │
                                    │    (8080)       │
                                    └────────┬────────┘
                                             │
                          ┌──────────────────┼──────────────────┐
                          ▼                  ▼                  ▼
                   ┌──────────┐       ┌──────────┐       ┌──────────┐
                   │  MySQL   │       │  Redis   │       │ 高德API   │
                   └──────────┘       └──────────┘       └──────────┘
```

### 4.2 传统部署方式

#### 4.2.1 构建前端

```bash
cd frontend

# 设置生产环境变量
cp .env.example .env.production
# 编辑 .env.production

# 构建
npm run build

# 构建产物在 dist/ 目录
```

#### 4.2.2 构建后端

```bash
cd backend

# 打包
./mvnw clean package -DskipTests -Pprod

# JAR文件在 target/ 目录
```

#### 4.2.3 部署到服务器

```bash
# 上传文件到服务器
scp -r frontend/dist user@server:/var/www/trip-planner/
scp backend/target/trip-planner-0.0.1-SNAPSHOT.jar user@server:/opt/trip-planner/

# SSH到服务器
ssh user@server

# 创建后端服务
sudo vim /etc/systemd/system/trip-planner.service
```

**trip-planner.service 内容**：

```ini
[Unit]
Description=Trip Route Planner Backend
After=network.target mysql.service redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/trip-planner
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod trip-planner-0.0.1-SNAPSHOT.jar
EnvironmentFile=/opt/trip-planner/.env
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable trip-planner
sudo systemctl start trip-planner

# 查看状态
sudo systemctl status trip-planner
```

#### 4.2.4 配置Nginx

```nginx
# /etc/nginx/sites-available/trip-planner

server {
    listen 80;
    server_name your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # 前端静态资源
    root /var/www/trip-planner;
    index index.html;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:8080/api/health;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/trip-planner /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 4.3 Docker部署

#### 4.3.1 Dockerfile - 后端

```dockerfile
# backend/Dockerfile
FROM eclipse-temurin:17-jre-alpine

WORKDIR /app

COPY target/trip-planner-0.0.1-SNAPSHOT.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 4.3.2 Dockerfile - 前端

```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 4.3.3 docker-compose.yml

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: trip-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: trip_planner
      MYSQL_USER: trip_user
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./database/init-data.sql:/docker-entrypoint-initdb.d/02-init-data.sql
    ports:
      - "3306:3306"
    networks:
      - trip-network

  redis:
    image: redis:7-alpine
    container_name: trip-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - trip-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: trip-backend
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=trip_planner
      - DB_USER=trip_user
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - AMAP_WEBSERVICE_KEY=${AMAP_WEBSERVICE_KEY}
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    networks:
      - trip-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=/api
        - VITE_AMAP_JS_KEY=${AMAP_JS_KEY}
    container_name: trip-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - trip-network

volumes:
  mysql_data:
  redis_data:

networks:
  trip-network:
    driver: bridge
```

#### 4.3.4 启动Docker服务

```bash
# 创建环境变量文件
cp .env.example .env
# 编辑 .env 填入实际配置

# 构建并启动
docker-compose up -d --build

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

---

## 五、数据库运维

### 5.1 备份策略

```bash
# 创建备份脚本 /opt/scripts/backup-mysql.sh

#!/bin/bash
BACKUP_DIR="/opt/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
FILENAME="trip_planner_${DATE}.sql.gz"

mkdir -p ${BACKUP_DIR}

mysqldump -u trip_user -p${DB_PASSWORD} trip_planner | gzip > ${BACKUP_DIR}/${FILENAME}

# 删除7天前的备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: ${FILENAME}"
```

```bash
# 添加定时任务
sudo crontab -e

# 每天凌晨2点执行备份
0 2 * * * /opt/scripts/backup-mysql.sh >> /var/log/mysql-backup.log 2>&1
```

### 5.2 恢复数据

```bash
# 解压并恢复
gunzip < backup_file.sql.gz | mysql -u trip_user -p trip_planner
```

### 5.3 数据库迁移

使用Flyway或Liquibase管理数据库版本：

```
database/migrations/
├── V1__init_schema.sql
├── V2__add_visit_duration.sql
└── V3__add_indexes.sql
```

---

## 六、监控与日志

### 6.1 应用日志配置

**application-prod.yml**：

```yaml
logging:
  level:
    root: INFO
    com.trip: INFO
    org.springframework: WARN
  file:
    name: /var/log/trip-planner/app.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30
      total-size-cap: 3GB
```

### 6.2 日志查看

```bash
# 实时查看日志
tail -f /var/log/trip-planner/app.log

# 查看错误日志
grep ERROR /var/log/trip-planner/app.log

# 查看最近的请求
grep "POST /api/itineraries/generate" /var/log/trip-planner/app.log | tail -20
```

### 6.3 健康检查

**Spring Boot Actuator配置**：

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when_authorized
```

**健康检查脚本**：

```bash
#!/bin/bash
# /opt/scripts/health-check.sh

HEALTH_URL="http://localhost:8080/api/health"
ALERT_EMAIL="ops@example.com"

STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${HEALTH_URL})

if [ "$STATUS" != "200" ]; then
    echo "Health check failed with status: ${STATUS}" | mail -s "Trip Planner Alert" ${ALERT_EMAIL}
fi
```

### 6.4 性能监控

**关键指标**：

| 指标 | 阈值 | 说明 |
|-----|------|------|
| API响应时间 | P99 < 2s | 行程生成接口 < 10s |
| 错误率 | < 1% | 5xx错误比例 |
| CPU使用率 | < 80% | 持续高于需扩容 |
| 内存使用率 | < 80% | JVM堆内存 |
| 数据库连接 | < 80% | 连接池使用率 |

---

## 七、故障排查

### 7.1 常见问题

#### 问题1：行程生成超时

**现象**：生成行程返回超时错误

**排查步骤**：
```bash
# 1. 检查高德API连通性
curl "https://restapi.amap.com/v3/direction/walking?origin=100.1653,25.6969&destination=100.1428,25.7144&key=YOUR_KEY"

# 2. 检查Redis连接
redis-cli ping

# 3. 查看应用日志
grep "TimeoutException" /var/log/trip-planner/app.log
```

**解决方案**：
- 检查高德API配额是否用尽
- 检查Redis是否正常运行
- 增加超时时间或优化算法

#### 问题2：数据库连接失败

**现象**：应用启动失败，提示数据库连接错误

**排查步骤**：
```bash
# 1. 检查MySQL服务状态
sudo systemctl status mysql

# 2. 检查连接
mysql -u trip_user -p -h localhost trip_planner

# 3. 检查防火墙
sudo ufw status
```

**解决方案**：
- 确认MySQL服务正常运行
- 检查用户名密码是否正确
- 检查网络和防火墙配置

#### 问题3：前端无法访问API

**现象**：浏览器控制台显示CORS错误

**排查步骤**：
```bash
# 1. 检查Nginx配置
sudo nginx -t

# 2. 检查后端CORS配置
grep -r "CORS" backend/src/
```

**解决方案**：
- 确认后端CORS配置正确
- 确认Nginx代理配置正确

### 7.2 紧急恢复流程

```bash
# 1. 回滚到上一个版本
cd /opt/trip-planner
mv app.jar app.jar.broken
mv app.jar.backup app.jar
sudo systemctl restart trip-planner

# 2. 恢复数据库（如需要）
mysql -u trip_user -p trip_planner < /opt/backups/mysql/latest.sql

# 3. 清除Redis缓存（如需要）
redis-cli FLUSHDB
```

---

## 八、安全加固

### 8.1 服务器安全

```bash
# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 配置防火墙
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw enable

# 3. 禁用root SSH登录
sudo vim /etc/ssh/sshd_config
# 设置 PermitRootLogin no
sudo systemctl restart sshd

# 4. 安装fail2ban
sudo apt install fail2ban
sudo systemctl enable fail2ban
```

### 8.2 应用安全

| 措施 | 说明 |
|-----|------|
| HTTPS强制 | Nginx配置HTTP重定向到HTTPS |
| JWT过期 | Token 24小时过期 |
| 密码加密 | BCrypt加密存储 |
| SQL注入防护 | MyBatis参数化查询 |
| XSS防护 | 前端输入转义 |
| 限流 | 行程生成接口限流 |

### 8.3 敏感信息保护

```bash
# 环境变量文件权限
chmod 600 /opt/trip-planner/.env

# 日志脱敏
# 在logback配置中添加敏感信息过滤
```

---

## 九、扩展与优化

### 9.1 水平扩展

当单机无法承载时，可以进行以下扩展：

```
                    ┌─────────────────┐
                    │  负载均衡器      │
                    │  (Nginx/ALB)    │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            ▼                ▼                ▼
   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
   │  后端实例1   │  │  后端实例2   │  │  后端实例3   │
   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
          │                │                │
          └────────────────┼────────────────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
   │   MySQL     │  │   Redis     │  │  Redis      │
   │  主从复制   │  │   集群      │  │  Sentinel   │
   └─────────────┘  └─────────────┘  └─────────────┘
```

### 9.2 性能优化checklist

- [ ] 开启Gzip压缩
- [ ] 静态资源CDN加速
- [ ] 数据库查询优化（explain分析）
- [ ] Redis缓存预热
- [ ] JVM参数调优
- [ ] 连接池配置优化

---

## 十、运维检查清单

### 10.1 日常检查

| 检查项 | 频率 | 方法 |
|-------|------|------|
| 服务状态 | 每日 | systemctl status |
| 磁盘空间 | 每日 | df -h |
| 日志错误 | 每日 | grep ERROR |
| 数据库备份 | 每日 | 检查备份文件 |
| SSL证书 | 每月 | certbot renew |

### 10.2 上线检查

- [ ] 环境变量已正确配置
- [ ] 数据库迁移已执行
- [ ] 静态资源已构建
- [ ] Nginx配置已更新
- [ ] SSL证书有效
- [ ] 健康检查通过
- [ ] 回滚方案已准备
