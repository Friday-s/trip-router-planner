# 大理旅游线路规划平台 - 技术架构文档

> 版本：v1.0
> 更新日期：2026-01-27

---

## 一、技术栈选型

### 1.1 技术栈总览

| 层级 | 技术选型 | 版本要求 |
|-----|---------|---------|
| 前端框架 | Vue 3 + JavaScript | Vue 3.4+ |
| 构建工具 | Vite | 5.0+ |
| UI组件库 | Element Plus | 2.4+ |
| 状态管理 | Pinia | 2.1+ |
| HTTP客户端 | Axios | 1.6+ |
| 地图服务 | 高德地图 JS API | 2.0 |
| 后端框架 | Spring Boot | 3.2+ |
| 开发语言 | Java | 17+ |
| ORM框架 | MyBatis-Plus | 3.5+ |
| 数据库 | MySQL | 8.0+ |
| 缓存 | Redis | 7.0+ |
| 认证 | JWT | - |
| 数据工具 | Python | 3.10+ |

### 1.2 选型理由

#### 前端技术栈

| 技术 | 选型理由 |
|-----|---------|
| Vue 3 | 渐进式框架，学习曲线平缓，Composition API提供更好的代码组织 |
| JavaScript | 开发效率高，无需额外编译配置，团队上手快 |
| Vite | 开发体验好，HMR快，构建速度快 |
| Element Plus | 成熟稳定，组件丰富，文档完善 |
| Pinia | Vue官方推荐，API简洁，轻量级状态管理 |

#### 后端技术栈

| 技术 | 选型理由 |
|-----|---------|
| Spring Boot 3 | 企业级标准，生态丰富，社区活跃 |
| Java 17 | LTS版本，性能优化，新语法特性 |
| MyBatis-Plus | 简化CRUD，代码生成，分页插件 |
| MySQL 8 | 成熟稳定，JSON支持，窗口函数 |
| Redis | 高性能缓存，路线数据缓存 |

#### 地图服务

| 技术 | 选型理由 |
|-----|---------|
| 高德地图 | 国内地图数据准确，API稳定，文档完善 |

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                            客户端层                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────┐    ┌─────────────────┐                       │
│   │   Web浏览器      │    │   移动端浏览器   │                       │
│   │   (Vue3 SPA)    │    │   (响应式)       │                       │
│   └────────┬────────┘    └────────┬────────┘                       │
│            │                      │                                 │
│            └──────────┬───────────┘                                 │
│                       │                                             │
└───────────────────────┼─────────────────────────────────────────────┘
                        │ HTTPS
                        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                            网关层                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                     Nginx (反向代理)                         │  │
│   │   • 静态资源服务 (前端)                                       │  │
│   │   • API请求转发 (/api/* → Spring Boot)                       │  │
│   │   • HTTPS证书                                                │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└───────────────────────┬─────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           应用层                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                   Spring Boot 应用                           │  │
│   │                                                              │  │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │  │
│   │  │ 认证模块  │ │ POI模块  │ │ 行程模块  │ │ 社区模块  │       │  │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │  │
│   │                                                              │  │
│   │  ┌──────────┐ ┌──────────────────────────────────────┐      │  │
│   │  │ 管理模块  │ │          通用组件                     │      │  │
│   │  └──────────┘ │  • JWT拦截器  • 全局异常处理           │      │  │
│   │               │  • 响应封装    • 日志切面               │      │  │
│   │               └──────────────────────────────────────┘      │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└───────────────────────┬─────────────────────────────────────────────┘
                        │
          ┌─────────────┼─────────────┐
          ▼             ▼             ▼
┌────────────────┐ ┌──────────┐ ┌──────────────────┐
│    数据层       │ │  缓存层   │ │    外部服务层     │
├────────────────┤ ├──────────┤ ├──────────────────┤
│                │ │          │ │                  │
│  ┌──────────┐  │ │  Redis   │ │  高德地图API     │
│  │  MySQL   │  │ │          │ │  • 路线规划      │
│  │          │  │ │  • 路线  │ │  • POI搜索      │
│  │  • 用户  │  │ │    缓存  │ │                  │
│  │  • POI   │  │ │  • 会话  │ └──────────────────┘
│  │  • 行程  │  │ │    缓存  │
│  │  • 帖子  │  │ │          │
│  └──────────┘  │ └──────────┘
│                │
└────────────────┘
```

### 2.2 请求处理流程

```
客户端请求
    │
    ▼
┌─────────────────────────────────────────┐
│  Nginx (80/443)                         │
│  • 静态资源 → 直接返回                    │
│  • /api/* → 转发到 Spring Boot          │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│  Spring Boot Filter Chain               │
│  • CorsFilter (跨域处理)                 │
│  • JwtFilter (Token校验)                │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│  Controller                             │
│  • 参数校验                              │
│  • 调用Service                          │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│  Service                                │
│  • 业务逻辑处理                          │
│  • 调用Mapper或外部API                   │
└─────────────────────────────────────────┘
    │
    ├──────────────┬──────────────┐
    ▼              ▼              ▼
┌─────────┐  ┌─────────┐  ┌─────────────┐
│  Mapper │  │  Redis  │  │  高德API    │
│ (MySQL) │  │ (缓存)  │  │  (外部)     │
└─────────┘  └─────────┘  └─────────────┘
```

---

## 三、模块划分

### 3.1 后端模块结构

```
com.trip
├── common/                 # 通用模块
│   ├── config/            # 配置类
│   │   ├── WebConfig.java         # Web配置(CORS等)
│   │   ├── SecurityConfig.java    # 安全配置
│   │   ├── RedisConfig.java       # Redis配置
│   │   └── AmapConfig.java        # 高德地图配置
│   ├── exception/         # 异常处理
│   │   ├── BizException.java      # 业务异常
│   │   └── GlobalExceptionHandler.java
│   ├── response/          # 响应封装
│   │   ├── Result.java            # 统一响应体
│   │   └── ResultCode.java        # 响应码枚举
│   ├── interceptor/       # 拦截器
│   │   └── JwtInterceptor.java    # JWT校验
│   └── util/              # 工具类
│       ├── JwtUtil.java           # JWT工具
│       └── PasswordUtil.java      # 密码工具
│
├── auth/                   # 认证模块
│   ├── controller/
│   │   └── AuthController.java
│   ├── service/
│   │   └── AuthService.java
│   └── dto/
│       ├── LoginRequest.java
│       ├── RegisterRequest.java
│       └── LoginResponse.java
│
├── user/                   # 用户模块
│   ├── entity/
│   │   └── User.java
│   ├── mapper/
│   │   └── UserMapper.java
│   └── service/
│       └── UserService.java
│
├── poi/                    # POI模块
│   ├── controller/
│   │   └── PoiController.java
│   ├── service/
│   │   └── PoiService.java
│   ├── entity/
│   │   └── Poi.java
│   ├── mapper/
│   │   └── PoiMapper.java
│   └── dto/
│       ├── PoiListRequest.java
│       └── PoiResponse.java
│
├── itinerary/              # 行程模块 (核心)
│   ├── controller/
│   │   └── ItineraryController.java
│   ├── service/
│   │   ├── ItineraryService.java          # 行程CRUD
│   │   ├── ItineraryGenerateService.java  # 行程生成主服务
│   │   ├── CandidatePoolService.java      # 候选池筛选
│   │   ├── DayAllocationService.java      # 分天分配
│   │   ├── InDayOrderingService.java      # 日内排序
│   │   └── RouteLegService.java           # 路段计算
│   ├── entity/
│   │   ├── Itinerary.java
│   │   ├── ItineraryDay.java
│   │   ├── ItineraryItem.java
│   │   └── RouteLeg.java
│   ├── mapper/
│   │   ├── ItineraryMapper.java
│   │   ├── ItineraryDayMapper.java
│   │   ├── ItineraryItemMapper.java
│   │   └── RouteLegMapper.java
│   └── dto/
│       ├── GenerateRequest.java
│       └── ItineraryResponse.java
│
├── amap/                   # 高德地图模块
│   ├── service/
│   │   └── AmapService.java
│   └── dto/
│       ├── RouteResponse.java
│       └── WalkRouteResponse.java
│
├── community/              # 社区模块
│   ├── controller/
│   │   └── PostController.java
│   ├── service/
│   │   ├── PostService.java
│   │   ├── LikeService.java
│   │   └── FavoriteService.java
│   ├── entity/
│   │   ├── Post.java
│   │   ├── Like.java
│   │   └── Favorite.java
│   ├── mapper/
│   │   ├── PostMapper.java
│   │   ├── LikeMapper.java
│   │   └── FavoriteMapper.java
│   └── dto/
│       ├── PostListRequest.java
│       ├── PostCreateRequest.java
│       └── PostResponse.java
│
└── admin/                  # 管理模块
    ├── controller/
    │   ├── AdminPoiController.java
    │   ├── AdminPostController.java
    │   └── AdminStatsController.java
    └── dto/
        └── StatsResponse.java
```

### 3.2 前端模块结构

```
src/
├── api/                    # API接口层
│   ├── index.js           # Axios实例配置
│   ├── auth.js            # 认证接口
│   ├── poi.js             # POI接口
│   ├── itinerary.js       # 行程接口
│   ├── post.js            # 帖子接口
│   └── admin.js           # 管理接口
│
├── assets/                 # 静态资源
│   ├── images/
│   └── styles/
│       ├── variables.scss # 样式变量
│       └── global.scss    # 全局样式
│
├── components/             # 通用组件
│   ├── common/            # 基础组件
│   │   ├── AppHeader.vue
│   │   ├── AppFooter.vue
│   │   └── Loading.vue
│   ├── itinerary/         # 行程相关组件
│   │   ├── DayCard.vue    # 单日行程卡片
│   │   ├── PoiItem.vue    # POI项
│   │   └── LegInfo.vue    # 路段信息
│   ├── map/               # 地图组件
│   │   └── AmapMap.vue    # 高德地图封装
│   └── post/              # 帖子组件
│       ├── PostCard.vue   # 帖子卡片
│       └── LikeButton.vue # 点赞按钮
│
├── views/                  # 页面组件
│   ├── auth/
│   │   ├── Login.vue
│   │   └── Register.vue
│   ├── itinerary/
│   │   ├── Generate.vue   # 行程生成页
│   │   └── Detail.vue     # 行程详情页
│   ├── community/
│   │   ├── Square.vue     # 社区广场
│   │   └── PostDetail.vue # 帖子详情
│   ├── profile/
│   │   └── Index.vue      # 个人中心
│   └── admin/
│       ├── Pois.vue       # POI管理
│       ├── Posts.vue      # 帖子管理
│       └── Stats.vue      # 数据统计
│
├── router/                 # 路由配置
│   └── index.js
│
├── stores/                 # 状态管理
│   ├── auth.js            # 认证状态
│   ├── itinerary.js       # 行程状态
│   └── app.js             # 应用全局状态
│
├── composables/            # 组合式函数
│   ├── useAuth.js         # 认证相关
│   ├── useMap.js          # 地图相关
│   └── useLoading.js      # 加载状态
│
├── utils/                  # 工具函数
│   ├── request.js         # 请求封装
│   ├── storage.js         # 本地存储
│   └── format.js          # 格式化工具
│
├── App.vue
└── main.js
```

---

## 四、项目目录结构

### 4.1 完整项目结构

```
trip-route-planner/
│
├── docs/                           # 项目文档
│   ├── 01-产品需求文档.md
│   ├── 02-技术架构文档.md
│   ├── 03-数据库设计文档.md
│   ├── 04-API接口文档.md
│   ├── 05-核心算法文档.md
│   └── 06-部署运维文档.md
│
├── frontend/                       # 前端项目
│   ├── public/
│   │   └── favicon.ico
│   ├── src/
│   │   ├── api/
│   │   ├── assets/
│   │   ├── components/
│   │   ├── composables/
│   │   ├── router/
│   │   ├── stores/
│   │   ├── utils/
│   │   ├── views/
│   │   ├── App.vue
│   │   └── main.js
│   ├── index.html
│   ├── package.json
│   ├── vite.config.js
│   └── .env.example
│
├── backend/                        # 后端项目
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/com/trip/
│   │   │   │   ├── TripApplication.java
│   │   │   │   ├── common/
│   │   │   │   ├── auth/
│   │   │   │   ├── user/
│   │   │   │   ├── poi/
│   │   │   │   ├── itinerary/
│   │   │   │   ├── amap/
│   │   │   │   ├── community/
│   │   │   │   └── admin/
│   │   │   └── resources/
│   │   │       ├── application.yml
│   │   │       ├── application-dev.yml
│   │   │       ├── application-prod.yml
│   │   │       └── mapper/
│   │   └── test/
│   ├── pom.xml
│   └── .env.example
│
├── database/                       # 数据库脚本
│   ├── schema.sql                 # 表结构
│   ├── init-data.sql              # 初始数据
│   └── migrations/                # 迁移脚本
│
├── python-tools/                   # Python工具
│   ├── poi_collector.py           # POI采集
│   ├── poi_processor.py           # 数据处理
│   ├── requirements.txt
│   └── data/
│       └── pois.json
│
├── deploy/                         # 部署配置
│   ├── docker-compose.yml
│   ├── nginx.conf
│   └── Dockerfile
│
├── .gitignore
└── README.md
```

---

## 五、第三方服务集成

### 5.1 高德地图集成

#### 需要申请的Key

| Key类型 | 用途 | 暴露位置 |
|--------|------|---------|
| Web服务Key | 后端调用路线规划API | 后端环境变量 |
| JS API Key | 前端地图展示 | 前端代码（需配置域名白名单） |

#### 后端使用的API

| API | 用途 | 文档 |
|-----|------|------|
| 步行路线规划 | 计算步行时间 | `/v3/direction/walking` |
| 驾车路线规划 | 计算驾车时间 | `/v3/direction/driving` |
| 公交路线规划 | 计算公交时间 | `/v3/direction/transit/integrated` |
| POI搜索 | 数据采集 | `/v3/place/text` |

#### 前端使用的功能

| 功能 | 用途 |
|-----|------|
| Map | 地图实例化和控制 |
| Marker | POI标记点 |
| Polyline | 路线连线 |
| InfoWindow | 点击显示信息 |

### 5.2 高德API调用封装

```java
@Service
public class AmapService {

    @Value("${amap.webservice.key}")
    private String key;

    @Value("${amap.webservice.base-url}")
    private String baseUrl;

    private final RestTemplate restTemplate;
    private final RedisTemplate<String, Object> redisTemplate;

    // 缓存Key前缀
    private static final String CACHE_PREFIX = "route:";
    private static final Duration CACHE_TTL = Duration.ofDays(7);

    /**
     * 获取步行路线
     */
    public RouteResult getWalkRoute(double fromLng, double fromLat,
                                     double toLng, double toLat) {
        String cacheKey = buildCacheKey("walk", fromLng, fromLat, toLng, toLat);

        // 1. 查缓存
        RouteResult cached = (RouteResult) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }

        // 2. 调用API
        String url = String.format("%s/direction/walking?origin=%s,%s&destination=%s,%s&key=%s",
            baseUrl, fromLng, fromLat, toLng, toLat, key);

        try {
            AmapWalkResponse response = restTemplate.getForObject(url, AmapWalkResponse.class);
            RouteResult result = parseWalkResponse(response);

            // 3. 写缓存
            redisTemplate.opsForValue().set(cacheKey, result, CACHE_TTL);

            return result;
        } catch (Exception e) {
            log.error("高德步行路线API调用失败", e);
            return null; // 降级处理
        }
    }
}
```

---

## 六、开发规范

### 6.1 Git分支规范

```
main          # 生产分支，只接受PR合并
  │
  └── develop # 开发分支，日常开发
        │
        ├── feature/xxx  # 功能分支
        ├── fix/xxx      # Bug修复分支
        └── refactor/xxx # 重构分支
```

### 6.2 提交信息规范

```
<type>(<scope>): <subject>

type:
  - feat: 新功能
  - fix: Bug修复
  - docs: 文档
  - style: 代码格式
  - refactor: 重构
  - test: 测试
  - chore: 构建/工具

示例:
feat(itinerary): 实现行程生成算法
fix(auth): 修复token过期未刷新问题
docs(api): 补充接口文档
```

### 6.3 代码规范

#### Java规范
- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- Service层方法需要有JavaDoc注释
- 异常统一使用BizException抛出

#### JavaScript规范
- 使用ESLint + Prettier格式化
- 组件使用`<script setup>`语法
- Props使用defineProps定义
- 使用JSDoc注释增强代码可读性

### 6.4 API规范

- RESTful风格
- 统一响应格式
- 使用HTTP状态码
- 错误信息用户友好

---

## 七、安全设计

### 7.1 认证与授权

```
┌────────────────────────────────────────────────────┐
│                    JWT认证流程                      │
└────────────────────────────────────────────────────┘

1. 登录
   Client ──POST /api/auth/login──► Server
                                      │
                                      ▼
                              验证用户名密码
                                      │
                                      ▼
                              生成JWT Token
                                      │
   Client ◄──── {token, user} ────────┘

2. 请求接口
   Client ──Header: Authorization: Bearer <token>──► Server
                                                       │
                                                       ▼
                                               JwtInterceptor
                                                       │
                                               ┌───────┴───────┐
                                               ▼               ▼
                                           验证成功         验证失败
                                               │               │
                                               ▼               ▼
                                           继续处理       返回401
```

### 7.2 密码安全

```java
// 使用BCrypt加密
@Component
public class PasswordUtil {

    private final BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();

    public String encode(String rawPassword) {
        return encoder.encode(rawPassword);
    }

    public boolean matches(String rawPassword, String encodedPassword) {
        return encoder.matches(rawPassword, encodedPassword);
    }
}
```

### 7.3 敏感信息保护

| 信息类型 | 存储方式 |
|---------|---------|
| 数据库密码 | 环境变量 |
| JWT密钥 | 环境变量 |
| 高德Web服务Key | 环境变量 |
| 高德JS Key | 前端代码（配置域名白名单） |

---

## 八、性能设计

### 8.1 缓存策略

| 缓存对象 | 缓存位置 | TTL | 更新策略 |
|---------|---------|-----|---------|
| 路线数据 | Redis | 7天 | 过期更新 |
| POI列表 | Redis | 1小时 | 手动失效 |
| 用户信息 | 本地内存 | 5分钟 | 过期更新 |

### 8.2 并发控制

```java
// 使用Semaphore限制并发调用高德API
@Service
public class AmapService {

    // 限制同时最多10个并发请求
    private final Semaphore semaphore = new Semaphore(10);

    public RouteResult getRoute(...) {
        try {
            semaphore.acquire();
            return doGetRoute(...);
        } finally {
            semaphore.release();
        }
    }
}
```

### 8.3 数据库优化

- 使用连接池(HikariCP)
- 合理使用索引
- 避免N+1查询
- 大列表使用分页

---

## 九、错误处理

### 9.1 全局异常处理

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BizException.class)
    public Result<Void> handleBizException(BizException e) {
        return Result.fail(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.fail(500, "系统繁忙，请稍后重试");
    }
}
```

### 9.2 降级策略

| 场景 | 降级方案 |
|-----|---------|
| 高德API超时 | 返回null，前端显示"路线暂不可用" |
| 高德API限流 | 使用缓存数据，无缓存则跳过 |
| Redis不可用 | 降级为数据库查询 |
| 行程生成超时 | 返回已计算的部分结果 |
