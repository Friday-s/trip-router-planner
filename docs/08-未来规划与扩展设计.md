# 大理旅游线路规划平台 - 未来规划与扩展设计

> 版本：v1.0
> 更新日期：2026-01-27
> 状态：规划中

---

## 一、版本规划总览

### 1.1 版本路线图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           版本演进路线                                    │
└─────────────────────────────────────────────────────────────────────────┘

  MVP v1.0                v1.5                  v2.0                 v3.0
     │                     │                     │                     │
     ▼                     ▼                     ▼                     ▼
┌─────────┐          ┌─────────┐          ┌─────────┐          ┌─────────┐
│ 核心功能 │    →     │ 功能完善 │    →     │ 智能升级 │    →     │ 平台化   │
│         │          │         │          │         │          │         │
│• 行程生成│          │• 行程编辑│          │• 本地算法│          │• 多城市  │
│• 地图展示│          │• 评论功能│          │• 用户画像│          │• 开放API│
│• 社区分享│          │• 天气集成│          │• 智能推荐│          │• B端服务│
│• 后台管理│          │• 导出功能│          │• 实时优化│          │• 数据分析│
└─────────┘          └─────────┘          └─────────┘          └─────────┘
     │                     │                     │                     │
   当前                  3个月后               6个月后              12个月后
```

### 1.2 各版本功能清单

| 版本 | 核心功能 | 技术升级 | 预计时间 |
|-----|---------|---------|---------|
| **MVP v1.0** | 行程生成、地图展示、社区基础功能、后台管理 | AI API调用生成 | 当前 |
| **v1.5** | 行程编辑、评论互动、天气集成、PDF导出 | 优化缓存策略 | +3个月 |
| **v2.0** | 本地推荐算法、用户画像、个性化推荐 | 算法引擎重构 | +6个月 |
| **v3.0** | 多城市支持、开放API、B端服务 | 微服务架构 | +12个月 |

---

## 二、推荐算法演进设计

### 2.1 算法抽象层设计

为了支持从 AI API 到本地算法的平滑切换，设计统一的算法接口层：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        推荐引擎抽象架构                                    │
└─────────────────────────────────────────────────────────────────────────┘

                         业务层调用
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    RecommendationEngine (接口)                           │
│                                                                          │
│  + generateItinerary(request) : ItineraryPlan                           │
│  + labelPoi(poi) : PoiLabel                                             │
│  + getEngineType() : String                                             │
└─────────────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│  AIRecommendation │ │ RuleRecommendation│ │ HybridRecommend  │
│  Engine           │ │ Engine            │ │ ation Engine     │
├──────────────────┤ ├──────────────────┤ ├──────────────────┤
│ • DeepSeek API   │ │ • 规则引擎        │ │ • AI + 规则混合  │
│ • Claude API     │ │ • 本地算法        │ │ • 降级兼容       │
│ • GPT API        │ │ • 统计模型        │ │                  │
└──────────────────┘ └──────────────────┘ └──────────────────┘

         MVP阶段              v2.0阶段            v2.5阶段
```

### 2.2 接口定义

```java
/**
 * 推荐引擎接口 - 所有推荐算法实现此接口
 */
public interface RecommendationEngine {

    /**
     * 生成行程
     * @param request 用户请求（天数、主题、偏好等）
     * @param candidates 候选POI列表
     * @return 行程计划
     */
    ItineraryPlan generateItinerary(GenerateRequest request, List<Poi> candidates);

    /**
     * 智能标注POI
     * @param poi 基础POI信息
     * @return 标注结果
     */
    PoiLabel labelPoi(PoiBasicInfo poi);

    /**
     * 获取引擎类型
     */
    String getEngineType();

    /**
     * 获取引擎优先级（数值越大优先级越高）
     */
    int getPriority();

    /**
     * 检查引擎是否可用
     */
    boolean isAvailable();
}
```

### 2.3 MVP阶段：AI API实现

```java
@Service
@ConditionalOnProperty(name = "recommendation.engine", havingValue = "ai", matchIfMissing = true)
public class AIRecommendationEngine implements RecommendationEngine {

    private final DeepSeekClient deepSeekClient;

    @Override
    public ItineraryPlan generateItinerary(GenerateRequest request, List<Poi> candidates) {
        // 调用DeepSeek API生成行程
        String prompt = buildItineraryPrompt(request, candidates);
        String response = deepSeekClient.chat(prompt);
        return parseItineraryPlan(response);
    }

    @Override
    public PoiLabel labelPoi(PoiBasicInfo poi) {
        // 调用DeepSeek API标注POI
        String prompt = buildLabelPrompt(poi);
        String response = deepSeekClient.chat(prompt);
        return parsePoiLabel(response);
    }

    @Override
    public String getEngineType() {
        return "AI";
    }

    @Override
    public int getPriority() {
        return 100;
    }

    @Override
    public boolean isAvailable() {
        return deepSeekClient.healthCheck();
    }
}
```

### 2.4 v2.0阶段：本地规则引擎实现

```java
@Service
@ConditionalOnProperty(name = "recommendation.engine", havingValue = "rule")
public class RuleRecommendationEngine implements RecommendationEngine {

    private final PoiScoringService scoringService;
    private final DayAllocationService allocationService;
    private final RouteOptimizationService routeService;

    @Override
    public ItineraryPlan generateItinerary(GenerateRequest request, List<Poi> candidates) {
        // Step 1: 基于规则的候选池评分
        List<ScoredPoi> scored = scoringService.score(candidates, request);

        // Step 2: 分天分配（基于区域聚类）
        List<List<Poi>> dayGroups = allocationService.allocate(scored, request.getDays());

        // Step 3: 日内路径优化（2-opt算法）
        for (List<Poi> dayPois : dayGroups) {
            routeService.optimize(dayPois);
        }

        // Step 4: 构建行程计划
        return buildPlan(dayGroups, request);
    }

    @Override
    public PoiLabel labelPoi(PoiBasicInfo poi) {
        // 基于规则的标注
        return PoiLabel.builder()
            .area(inferArea(poi.getAddress(), poi.getLocation()))
            .tags(inferTags(poi.getName(), poi.getType()))
            .visitDuration(inferDuration(poi.getType()))
            .build();
    }

    @Override
    public String getEngineType() {
        return "RULE";
    }

    @Override
    public int getPriority() {
        return 50;
    }

    @Override
    public boolean isAvailable() {
        return true; // 本地引擎始终可用
    }
}
```

### 2.5 配置切换

```yaml
# application.yml

recommendation:
  # 引擎类型: ai / rule / hybrid
  engine: ai

  # AI引擎配置
  ai:
    provider: deepseek  # deepseek / openai / claude
    timeout: 30000
    retry: 2

  # 规则引擎配置
  rule:
    scoring:
      theme-weight: 20
      popularity-weight: 10
      distance-weight: 15
    optimization:
      algorithm: 2-opt  # nearest-neighbor / 2-opt / simulated-annealing

  # 混合引擎配置
  hybrid:
    primary: ai
    fallback: rule
    fallback-on-timeout: true
```

---

## 三、数据库扩展设计

### 3.1 预留字段设计

以下字段在MVP阶段预留，后续版本启用：

#### POI表扩展字段

| 字段 | 类型 | 版本 | 用途 |
|-----|------|------|------|
| popularity_score | INT | v1.5 | 热度评分（0-100） |
| seasonal_tags | JSON | v1.5 | 季节性标签 |
| weather_suitable | JSON | v1.5 | 适合的天气类型 |
| crowd_level | JSON | v2.0 | 各时段拥挤程度 |
| user_rating | DECIMAL | v2.0 | 用户评分统计 |
| booking_required | BOOLEAN | v2.0 | 是否需要预约 |

#### 用户表扩展字段

| 字段 | 类型 | 版本 | 用途 |
|-----|------|------|------|
| preferences | JSON | v2.0 | 用户偏好画像 |
| travel_history | JSON | v2.0 | 历史行程摘要 |
| favorite_themes | JSON | v2.0 | 偏好主题 |

### 3.2 新增表设计（后续版本）

#### 评论表 (comments) - v1.5

```sql
CREATE TABLE comments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    post_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    parent_id BIGINT DEFAULT NULL COMMENT '回复的评论ID',
    like_count INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    KEY idx_post_id (post_id),
    KEY idx_user_id (user_id)
) COMMENT='评论表';
```

#### 用户关注表 (follows) - v1.5

```sql
CREATE TABLE follows (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    follower_id BIGINT NOT NULL,
    following_id BIGINT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_follow (follower_id, following_id)
) COMMENT='用户关注表';
```

#### 用户行为表 (user_behaviors) - v2.0

```sql
CREATE TABLE user_behaviors (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    behavior_type ENUM('view', 'like', 'favorite', 'generate', 'share') NOT NULL,
    target_type ENUM('poi', 'post', 'itinerary') NOT NULL,
    target_id BIGINT NOT NULL,
    context JSON DEFAULT NULL COMMENT '行为上下文',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    KEY idx_user_behavior (user_id, behavior_type),
    KEY idx_target (target_type, target_id)
) COMMENT='用户行为记录表';
```

#### 推荐日志表 (recommendation_logs) - v2.0

```sql
CREATE TABLE recommendation_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT DEFAULT NULL,
    request_params JSON NOT NULL COMMENT '请求参数',
    engine_type VARCHAR(20) NOT NULL COMMENT '使用的引擎类型',
    result_summary JSON NOT NULL COMMENT '结果摘要',
    latency_ms INT NOT NULL COMMENT '耗时毫秒',
    feedback_score INT DEFAULT NULL COMMENT '用户反馈评分',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    KEY idx_user_id (user_id),
    KEY idx_engine (engine_type),
    KEY idx_created (created_at)
) COMMENT='推荐日志表';
```

---

## 四、功能扩展清单

### 4.1 v1.5 功能清单

| 功能 | 描述 | 优先级 |
|-----|------|--------|
| 行程编辑 | 用户可调整生成的行程（拖拽排序、增删POI） | P0 |
| 评论功能 | 帖子下发表评论、回复评论 | P1 |
| 天气集成 | 显示目的地天气，推荐室内/室外景点 | P1 |
| PDF导出 | 行程导出为PDF文件 | P2 |
| 日历同步 | 行程同步到手机日历 | P2 |
| 分享海报 | 生成行程分享海报图片 | P2 |

### 4.2 v2.0 功能清单

| 功能 | 描述 | 优先级 |
|-----|------|--------|
| 本地推荐算法 | 脱离AI API依赖，本地计算推荐 | P0 |
| 用户画像 | 基于行为分析用户偏好 | P0 |
| 个性化推荐 | 根据用户历史推荐相似行程 | P1 |
| 实时优化 | 根据实时交通、天气调整建议 | P1 |
| 门票集成 | 对接OTA平台展示门票信息 | P2 |
| 攻略生成 | 自动生成图文攻略 | P2 |

### 4.3 v3.0 功能清单

| 功能 | 描述 | 优先级 |
|-----|------|--------|
| 多城市支持 | 扩展到其他旅游城市 | P0 |
| 开放API | 提供API给第三方调用 | P1 |
| B端服务 | 面向旅行社、OTA的批量服务 | P1 |
| 数据分析 | 平台数据分析后台 | P2 |
| 广告系统 | POI推广、置顶功能 | P2 |

---

## 五、本地算法详细设计

### 5.1 评分模型

当切换到本地算法时，使用以下评分模型：

```
POI综合评分 =
    基础分(10)
    + 主题匹配分(0-30)
    + 热度分(0-20)
    + 评分分(0-20)
    + 时间适配分(0-10)
    + 距离惩罚分(-20~0)

主题匹配分 =
    if (POI.tags 包含 用户主题) → 30
    elif (POI.tags 包含 相关主题) → 15
    else → 0

热度分 = POI.popularity_score / 5

评分分 = (POI.user_rating - 3) * 10  // 3分为基准

时间适配分 =
    if (POI适合当前季节) → 10
    elif (POI全年适合) → 5
    else → 0

距离惩罚分 = -min(20, 与最近已选POI的距离/1000)
```

### 5.2 路径优化算法

**2-opt算法**（比最近邻更优）：

```java
public List<Poi> optimizeRoute(List<Poi> pois) {
    List<Poi> route = new ArrayList<>(pois);
    boolean improved = true;

    while (improved) {
        improved = false;
        for (int i = 0; i < route.size() - 1; i++) {
            for (int j = i + 2; j < route.size(); j++) {
                double delta = calculateSwapDelta(route, i, j);
                if (delta < -0.01) { // 有改进
                    reverse(route, i + 1, j);
                    improved = true;
                }
            }
        }
    }

    return route;
}

private double calculateSwapDelta(List<Poi> route, int i, int j) {
    // 计算交换边后的距离变化
    double before = distance(route.get(i), route.get(i+1))
                  + distance(route.get(j), route.get((j+1) % route.size()));
    double after = distance(route.get(i), route.get(j))
                 + distance(route.get(i+1), route.get((j+1) % route.size()));
    return after - before;
}
```

### 5.3 用户画像模型

```java
public class UserProfile {
    private Long userId;

    // 主题偏好（基于历史行为统计）
    private Map<String, Double> themePreferences;

    // 行程节奏偏好
    private String pacePreference;  // relaxed / moderate / intensive

    // 游玩时长偏好
    private int avgDailyHours;

    // 交通方式偏好
    private String transportPreference;  // walk / transit / drive

    // 人群类型
    private List<String> travelWith;  // solo / couple / family / friends

    // 消费水平
    private String budgetLevel;  // budget / moderate / luxury
}
```

---

## 六、技术升级路径

### 6.1 从AI到本地的迁移步骤

```
Phase 1: 数据积累（MVP阶段）
├── 记录所有AI生成的结果
├── 收集用户反馈和行为
└── 建立评价数据集

Phase 2: 模型训练（v1.5阶段）
├── 分析AI生成结果的模式
├── 提取规则和权重
└── 构建初版规则引擎

Phase 3: 并行验证（v2.0阶段）
├── 规则引擎与AI引擎并行运行
├── A/B测试对比效果
└── 调优规则参数

Phase 4: 平滑切换
├── 配置开关控制引擎选择
├── 监控切换后的指标
└── 完全脱离AI依赖
```

### 6.2 配置开关设计

```yaml
# 推荐引擎开关
recommendation:
  engine:
    # 主引擎：ai / rule / hybrid
    primary: ai

    # 降级引擎
    fallback: rule

    # A/B测试配置
    ab-test:
      enabled: false
      ai-ratio: 0.5  # 50%流量走AI

    # 监控告警
    monitoring:
      latency-threshold-ms: 3000
      error-rate-threshold: 0.05
```

---

## 七、扩展检查清单

### 7.1 升级到v1.5检查清单

- [ ] 数据库新增 comments、follows 表
- [ ] POI表添加 popularity_score 字段
- [ ] 实现评论API
- [ ] 集成天气API
- [ ] 实现PDF导出功能
- [ ] 前端行程编辑功能

### 7.2 升级到v2.0检查清单

- [ ] 实现 RuleRecommendationEngine
- [ ] 实现 2-opt 路径优化算法
- [ ] 新增 user_behaviors、recommendation_logs 表
- [ ] 实现用户画像服务
- [ ] 配置引擎切换开关
- [ ] A/B测试基础设施
- [ ] 监控指标埋点

### 7.3 升级到v3.0检查清单

- [ ] 多城市POI数据导入流程
- [ ] API网关和限流
- [ ] 开放API文档（OpenAPI 3.0）
- [ ] B端管理后台
- [ ] 数据分析看板
