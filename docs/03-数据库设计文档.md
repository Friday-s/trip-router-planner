# 旅游线路规划平台设计与实现 - 数据库设计文档

> 版本：v1.0
> 更新日期：2026-01-28
> 数据库：MySQL 8.0+

---

## 一、ER图

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   users     │       │   itineraries   │       │      pois       │
├─────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)     │◄──┐   │ id (PK)         │   ┌──►│ id (PK)         │
│ username    │   │   │ user_id (FK)────┼───┘   │ name            │
│ email       │   │   │ city            │       │ lng             │
│ password    │   └───┼─────────────────┤       │ lat             │
│ role        │       │ days            │       │ area            │
│ ...         │       │ theme           │       │ tags            │
└─────────────┘       │ ...             │       │ ...             │
      │               └────────┬────────┘       └────────▲────────┘
      │                        │                         │
      │                        │ 1:N                     │
      │                        ▼                         │
      │               ┌─────────────────┐                │
      │               │ itinerary_days  │                │
      │               ├─────────────────┤                │
      │               │ id (PK)         │                │
      │               │ itinerary_id(FK)│                │
      │               │ day_index       │                │
      │               └────────┬────────┘                │
      │                        │                         │
      │                        │ 1:N                     │
      │                        ▼                         │
      │               ┌─────────────────┐                │
      │               │ itinerary_items │                │
      │               ├─────────────────┤                │
      │               │ id (PK)         │                │
      │               │ day_id (FK)     │                │
      │               │ poi_id (FK)─────┼────────────────┘
      │               │ order_index     │
      │               └─────────────────┘
      │
      │               ┌─────────────────┐
      │               │   route_cache   │  (独立缓存表)
      │               ├─────────────────┤
      │               │ id (PK)         │
      │               │ from_poi_id(FK) │──────┐
      │               │ to_poi_id (FK)  │──────┤
      │               │ walk_duration   │      │
      │               │ drive_duration  │      ▼
      │               │ transit_duration│   ┌──────┐
      │               │ ...             │   │ pois │
      │               └─────────────────┘   └──────┘
      │
      │               ┌─────────────────┐
      │               │     posts       │
      │               ├─────────────────┤
      │    ┌──────────┤ id (PK)         │
      │    │          │ author_id (FK)──┼──────┐
      │    │          │ itinerary_id(FK)│      │
      │    │          │ title           │      │
      │    │          │ ...             │      │
      │    │          └─────────────────┘      │
      │    │                                   │
      │    │ 1:N       ┌─────────────────┐     │
      │    │           │     likes       │     │
      │    │           ├─────────────────┤     │
      │    └──────────►│ id (PK)         │     │
      │                │ user_id (FK)────┼─────┤
      │                │ post_id (FK)    │     │
      │                └─────────────────┘     │
      │                                        │
      │    1:N         ┌─────────────────┐     │
      │                │   favorites     │     │
      │                ├─────────────────┤     │
      └───────────────►│ id (PK)         │     │
                       │ user_id (FK)────┼─────┘
                       │ post_id (FK)    │
                       └─────────────────┘
```

---

## 二、表结构详细定义

### 2.1 用户表 (users)

存储平台用户信息。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| username | VARCHAR(50) | NOT NULL, UNIQUE | - | 用户名 |
| email | VARCHAR(100) | NOT NULL, UNIQUE | - | 邮箱 |
| password | VARCHAR(255) | NOT NULL | - | 密码(BCrypt加密) |
| avatar | VARCHAR(500) | - | NULL | 头像URL |
| role | ENUM | NOT NULL | 'user' | 角色: user/admin |
| status | TINYINT | NOT NULL | 1 | 状态: 0禁用 1正常 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL COMMENT 'BCrypt加密',
    avatar VARCHAR(500) DEFAULT NULL,
    role ENUM('user', 'admin') NOT NULL DEFAULT 'user',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0禁用 1正常',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2.2 POI表 (pois)

存储景点信息。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| name | VARCHAR(100) | NOT NULL | - | 景点名称 |
| lng | DECIMAL(10,7) | NOT NULL | - | 经度 |
| lat | DECIMAL(10,7) | NOT NULL | - | 纬度 |
| address | VARCHAR(255) | - | NULL | 详细地址 |
| city | VARCHAR(50) | NOT NULL | - | 城市 |
| area | VARCHAR(50) | - | NULL | 区域(如:古城区、洱海周边) |
| tags | JSON | - | NULL | 标签数组 |
| brief | VARCHAR(500) | - | NULL | 简介 |
| cover_image | VARCHAR(500) | - | NULL | 封面图URL |
| visit_duration | INT | - | 60 | 预计游玩时长(分钟) |
| open_time | VARCHAR(100) | - | NULL | 营业时间描述 |
| ticket_price | DECIMAL(10,2) | - | NULL | 门票价格 |
| best_time | VARCHAR(200) | - | NULL | 最佳游玩时间（AI生成） |
| highlights | JSON | - | NULL | 景点亮点数组（AI生成） |
| suitable_for | JSON | - | NULL | 适合人群数组（AI生成） |
| tips | VARCHAR(500) | - | NULL | 游玩小贴士（AI生成） |
| difficulty | VARCHAR(20) | - | NULL | 游玩难度：轻松/适中/有挑战 |
| status | TINYINT | NOT NULL | 1 | 状态: 0下架 1上架 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

```sql
CREATE TABLE pois (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '景点名称',
    lng DECIMAL(10, 7) NOT NULL COMMENT '经度',
    lat DECIMAL(10, 7) NOT NULL COMMENT '纬度',
    address VARCHAR(255) DEFAULT NULL COMMENT '详细地址',
    city VARCHAR(50) NOT NULL COMMENT '城市',
    area VARCHAR(50) DEFAULT NULL COMMENT '区域',
    tags JSON DEFAULT NULL COMMENT '标签数组',
    brief VARCHAR(500) DEFAULT NULL COMMENT '简介',
    cover_image VARCHAR(500) DEFAULT NULL COMMENT '封面图URL',
    visit_duration INT DEFAULT 60 COMMENT '预计游玩时长(分钟)',
    open_time VARCHAR(100) DEFAULT NULL COMMENT '营业时间描述',
    ticket_price DECIMAL(10, 2) DEFAULT NULL COMMENT '门票价格',
    best_time VARCHAR(200) DEFAULT NULL COMMENT '最佳游玩时间',
    highlights JSON DEFAULT NULL COMMENT '景点亮点数组',
    suitable_for JSON DEFAULT NULL COMMENT '适合人群数组',
    tips VARCHAR(500) DEFAULT NULL COMMENT '游玩小贴士',
    difficulty VARCHAR(20) DEFAULT NULL COMMENT '游玩难度',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0下架 1上架',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_city_status (city, status),
    KEY idx_area (area)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='景点表';
```

### 2.3 行程表 (itineraries)

存储用户生成/保存的行程。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| user_id | BIGINT | FK, NULL | NULL | 用户ID(游客生成时为空) |
| city | VARCHAR(50) | NOT NULL | - | 城市 |
| days | INT | NOT NULL | - | 天数 |
| theme | VARCHAR(50) | - | NULL | 主题 |
| title | VARCHAR(100) | - | NULL | 行程标题（AI生成或用户自定义） |
| summary | VARCHAR(500) | - | NULL | 行程概述（AI生成） |
| tips | JSON | - | NULL | 整体贴士数组（AI生成） |
| status | TINYINT | NOT NULL | 1 | 状态: 0删除 1正常 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

```sql
CREATE TABLE itineraries (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT DEFAULT NULL COMMENT '用户ID,游客为空',
    city VARCHAR(50) NOT NULL COMMENT '城市',
    days INT NOT NULL COMMENT '天数',
    theme VARCHAR(50) DEFAULT NULL COMMENT '主题',
    title VARCHAR(100) DEFAULT NULL COMMENT '行程标题',
    summary VARCHAR(500) DEFAULT NULL COMMENT '行程概述',
    tips JSON DEFAULT NULL COMMENT '整体贴士数组',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0删除 1正常',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_user_id (user_id),
    KEY idx_city (city),
    CONSTRAINT fk_itinerary_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='行程表';
```

### 2.4 行程天表 (itinerary_days)

存储行程的每日安排。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| itinerary_id | BIGINT | FK, NOT NULL | - | 行程ID |
| day_index | INT | NOT NULL | - | 第几天(从1开始) |
| theme | VARCHAR(100) | - | NULL | 当日主题（AI生成） |
| notes | VARCHAR(500) | - | NULL | 当日备注/建议（AI生成） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE itinerary_days (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    itinerary_id BIGINT NOT NULL COMMENT '行程ID',
    day_index INT NOT NULL COMMENT '第几天,从1开始',
    theme VARCHAR(100) DEFAULT NULL COMMENT '当日主题',
    notes VARCHAR(500) DEFAULT NULL COMMENT '当日备注/建议',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_itinerary_id (itinerary_id),
    CONSTRAINT fk_day_itinerary FOREIGN KEY (itinerary_id) REFERENCES itineraries(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='行程天表';
```

### 2.5 行程项表 (itinerary_items)

存储每天的POI安排。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| day_id | BIGINT | FK, NOT NULL | - | 行程天ID |
| poi_id | BIGINT | FK, NOT NULL | - | POI ID |
| order_index | INT | NOT NULL | - | 当天顺序(从1开始) |
| start_time | VARCHAR(10) | - | NULL | 建议开始时间（如09:00） |
| tips | VARCHAR(500) | - | NULL | 游玩建议（AI生成） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE itinerary_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    day_id BIGINT NOT NULL COMMENT '行程天ID',
    poi_id BIGINT NOT NULL COMMENT 'POI ID',
    order_index INT NOT NULL COMMENT '当天顺序,从1开始',
    start_time VARCHAR(10) DEFAULT NULL COMMENT '建议开始时间',
    tips VARCHAR(500) DEFAULT NULL COMMENT '游玩建议',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_day_id (day_id),
    KEY idx_poi_id (poi_id),
    CONSTRAINT fk_item_day FOREIGN KEY (day_id) REFERENCES itinerary_days(id) ON DELETE CASCADE,
    CONSTRAINT fk_item_poi FOREIGN KEY (poi_id) REFERENCES pois(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='行程项表';
```

### 2.6 路线缓存表 (route_cache)

缓存POI之间的路线信息，独立于行程存储，可复用。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| from_poi_id | BIGINT | FK, NOT NULL | - | 起点POI ID |
| to_poi_id | BIGINT | FK, NOT NULL | - | 终点POI ID |
| distance_meter | INT | - | NULL | 距离(米) |
| walk_duration_sec | INT | - | NULL | 步行时长(秒) |
| drive_duration_sec | INT | - | NULL | 驾车时长(秒) |
| transit_duration_sec | INT | - | NULL | 公交时长(秒) |
| transit_transfers | INT | - | NULL | 公交换乘次数 |
| recommend_mode | VARCHAR(20) | - | NULL | 推荐交通方式(walk/drive/transit) |
| walk_path | JSON | - | NULL | 步行路径坐标数组 |
| drive_path | JSON | - | NULL | 驾车路径坐标数组 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

```sql
CREATE TABLE route_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    from_poi_id BIGINT NOT NULL COMMENT '起点POI ID',
    to_poi_id BIGINT NOT NULL COMMENT '终点POI ID',
    distance_meter INT DEFAULT NULL COMMENT '距离(米)',
    walk_duration_sec INT DEFAULT NULL COMMENT '步行时长(秒)',
    drive_duration_sec INT DEFAULT NULL COMMENT '驾车时长(秒)',
    transit_duration_sec INT DEFAULT NULL COMMENT '公交时长(秒)',
    transit_transfers INT DEFAULT NULL COMMENT '公交换乘次数',
    recommend_mode VARCHAR(20) DEFAULT NULL COMMENT '推荐交通方式',
    walk_path JSON DEFAULT NULL COMMENT '步行路径坐标',
    drive_path JSON DEFAULT NULL COMMENT '驾车路径坐标',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_from_to (from_poi_id, to_poi_id),
    KEY idx_to_poi (to_poi_id),
    CONSTRAINT fk_route_from_poi FOREIGN KEY (from_poi_id) REFERENCES pois(id) ON DELETE CASCADE,
    CONSTRAINT fk_route_to_poi FOREIGN KEY (to_poi_id) REFERENCES pois(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='路线缓存表';
```

**智能交通方式推荐规则**：

| 优先级 | 条件 | recommend_mode |
|--------|------|----------------|
| 1 | 步行时间 ≤ 15分钟 | walk |
| 2 | 距离 > 5km 或 换乘 ≥ 3次 | drive |
| 3 | 公交时间 ≤ 驾车时间×1.5 | transit |
| 4 | 默认 | drive |

**路径数据格式**：
```json
{
  "walk_path": [[100.1856, 25.6892], [100.1867, 25.6901], ...],
  "drive_path": [[100.1856, 25.6892], [100.1870, 25.6905], ...]
}
```

### 2.7 帖子表 (posts)

存储社区帖子。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| author_id | BIGINT | FK, NOT NULL | - | 作者ID |
| itinerary_id | BIGINT | FK, NOT NULL | - | 关联行程ID |
| title | VARCHAR(100) | NOT NULL | - | 标题 |
| summary | VARCHAR(500) | - | NULL | 摘要 |
| like_count | INT | NOT NULL | 0 | 点赞数 |
| favorite_count | INT | NOT NULL | 0 | 收藏数 |
| status | TINYINT | NOT NULL | 1 | 状态: 0下架 1正常 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

```sql
CREATE TABLE posts (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    author_id BIGINT NOT NULL COMMENT '作者ID',
    itinerary_id BIGINT NOT NULL COMMENT '关联行程ID',
    title VARCHAR(100) NOT NULL COMMENT '标题',
    summary VARCHAR(500) DEFAULT NULL COMMENT '摘要',
    like_count INT NOT NULL DEFAULT 0 COMMENT '点赞数',
    favorite_count INT NOT NULL DEFAULT 0 COMMENT '收藏数',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0下架 1正常',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_author_id (author_id),
    KEY idx_itinerary_id (itinerary_id),
    KEY idx_status_created (status, created_at DESC),
    KEY idx_status_like (status, like_count DESC),
    CONSTRAINT fk_post_author FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_post_itinerary FOREIGN KEY (itinerary_id) REFERENCES itineraries(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='帖子表';
```

### 2.8 点赞表 (likes)

存储用户点赞记录。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| user_id | BIGINT | FK, NOT NULL | - | 用户ID |
| post_id | BIGINT | FK, NOT NULL | - | 帖子ID |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE likes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    post_id BIGINT NOT NULL COMMENT '帖子ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_post (user_id, post_id),
    KEY idx_post_id (post_id),
    CONSTRAINT fk_like_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_like_post FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点赞表';
```

### 2.9 收藏表 (favorites)

存储用户收藏记录。

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|-----|------|------|--------|------|
| id | BIGINT | PK, AUTO_INCREMENT | - | 主键 |
| user_id | BIGINT | FK, NOT NULL | - | 用户ID |
| post_id | BIGINT | FK, NOT NULL | - | 帖子ID |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

```sql
CREATE TABLE favorites (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    post_id BIGINT NOT NULL COMMENT '帖子ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_post (user_id, post_id),
    KEY idx_post_id (post_id),
    CONSTRAINT fk_favorite_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_favorite_post FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

---

## 三、索引设计

### 3.1 索引总览

| 表名 | 索引名 | 类型 | 字段 | 用途 |
|-----|--------|------|------|------|
| users | uk_username | UNIQUE | username | 用户名唯一 |
| users | uk_email | UNIQUE | email | 邮箱唯一 |
| pois | idx_city_status | INDEX | city, status | 按城市查询上架POI |
| pois | idx_area | INDEX | area | 按区域查询 |
| itineraries | idx_user_id | INDEX | user_id | 查询用户的行程 |
| itineraries | idx_city | INDEX | city | 按城市查询 |
| itinerary_days | idx_itinerary_id | INDEX | itinerary_id | 查询行程的天 |
| itinerary_items | idx_day_id | INDEX | day_id | 查询某天的项 |
| route_cache | uk_from_to | UNIQUE | from_poi_id, to_poi_id | 路线唯一 |
| posts | idx_author_id | INDEX | author_id | 查询用户发布的帖子 |
| posts | idx_status_created | INDEX | status, created_at DESC | 最新排序 |
| posts | idx_status_like | INDEX | status, like_count DESC | 最热排序 |
| likes | uk_user_post | UNIQUE | user_id, post_id | 防止重复点赞 |
| favorites | uk_user_post | UNIQUE | user_id, post_id | 防止重复收藏 |

### 3.2 查询场景与索引对应

| 查询场景 | SQL示例 | 使用索引 |
|---------|---------|---------|
| 用户登录 | WHERE email = ? | uk_email |
| 查询上架POI | WHERE city = ? AND status = 1 | idx_city_status |
| 查询用户行程 | WHERE user_id = ? | idx_user_id |
| 社区最新帖子 | WHERE status = 1 ORDER BY created_at DESC | idx_status_created |
| 社区最热帖子 | WHERE status = 1 ORDER BY like_count DESC | idx_status_like |
| 查询是否点赞 | WHERE user_id = ? AND post_id = ? | uk_user_post |
| 查询路线缓存 | WHERE from_poi_id = ? AND to_poi_id = ? | uk_from_to |

---

## 四、数据字典

### 4.1 状态码定义

#### 用户状态 (users.status)

| 值 | 含义 |
|---|------|
| 0 | 禁用 |
| 1 | 正常 |

#### 用户角色 (users.role)

| 值 | 含义 |
|---|------|
| user | 普通用户 |
| admin | 管理员 |

#### POI状态 (pois.status)

| 值 | 含义 |
|---|------|
| 0 | 下架 |
| 1 | 上架 |

#### 行程状态 (itineraries.status)

| 值 | 含义 |
|---|------|
| 0 | 删除 |
| 1 | 正常 |

#### 帖子状态 (posts.status)

| 值 | 含义 |
|---|------|
| 0 | 下架 |
| 1 | 正常 |

### 4.2 POI标签定义

pois.tags 为JSON数组，可选值：

| 标签 | 含义 |
|-----|------|
| 古镇 | 古城、古镇类景点 |
| 自然风光 | 山水、湖泊等自然景观 |
| 民族文化 | 白族、少数民族文化体验 |
| 美食 | 餐厅、小吃街 |
| 摄影 | 适合拍照的景点 |
| 徒步 | 适合徒步的路线 |
| 亲子 | 适合带小孩的景点 |
| 小众 | 小众冷门景点 |

示例：`["古镇", "摄影", "民族文化"]`

### 4.3 区域定义

pois.area 可选值（大理）：

| 区域 | 包含景点示例 |
|-----|-------------|
| 古城区 | 大理古城、洋人街、人民路 |
| 洱海周边 | 洱海公园、才村码头、双廊 |
| 苍山 | 苍山国家地质公园、感通寺 |
| 喜洲 | 喜洲古镇、海舌生态公园 |
| 双廊 | 双廊古镇、南诏风情岛 |
| 剑川 | 沙溪古镇、石宝山 |

---

## 五、初始化脚本

### 5.1 完整建表脚本 (schema.sql)

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS trip_planner
    DEFAULT CHARACTER SET utf8mb4
    DEFAULT COLLATE utf8mb4_unicode_ci;

USE trip_planner;

-- 用户表
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL COMMENT 'BCrypt加密',
    avatar VARCHAR(500) DEFAULT NULL,
    role ENUM('user', 'admin') NOT NULL DEFAULT 'user',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0禁用 1正常',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- POI表
CREATE TABLE pois (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '景点名称',
    lng DECIMAL(10, 7) NOT NULL COMMENT '经度',
    lat DECIMAL(10, 7) NOT NULL COMMENT '纬度',
    address VARCHAR(255) DEFAULT NULL COMMENT '详细地址',
    city VARCHAR(50) NOT NULL COMMENT '城市',
    area VARCHAR(50) DEFAULT NULL COMMENT '区域',
    tags JSON DEFAULT NULL COMMENT '标签数组',
    brief VARCHAR(500) DEFAULT NULL COMMENT '简介',
    cover_image VARCHAR(500) DEFAULT NULL COMMENT '封面图URL',
    visit_duration INT DEFAULT 60 COMMENT '预计游玩时长(分钟)',
    open_time VARCHAR(100) DEFAULT NULL COMMENT '营业时间描述',
    ticket_price DECIMAL(10, 2) DEFAULT NULL COMMENT '门票价格',
    best_time VARCHAR(200) DEFAULT NULL COMMENT '最佳游玩时间',
    highlights JSON DEFAULT NULL COMMENT '景点亮点数组',
    suitable_for JSON DEFAULT NULL COMMENT '适合人群数组',
    tips VARCHAR(500) DEFAULT NULL COMMENT '游玩小贴士',
    difficulty VARCHAR(20) DEFAULT NULL COMMENT '游玩难度',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0下架 1上架',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_city_status (city, status),
    KEY idx_area (area)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='景点表';

-- 行程表
CREATE TABLE itineraries (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT DEFAULT NULL COMMENT '用户ID,游客为空',
    city VARCHAR(50) NOT NULL COMMENT '城市',
    days INT NOT NULL COMMENT '天数',
    theme VARCHAR(50) DEFAULT NULL COMMENT '主题',
    title VARCHAR(100) DEFAULT NULL COMMENT '行程标题',
    summary VARCHAR(500) DEFAULT NULL COMMENT '行程概述',
    tips JSON DEFAULT NULL COMMENT '整体贴士数组',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0删除 1正常',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_user_id (user_id),
    KEY idx_city (city),
    CONSTRAINT fk_itinerary_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='行程表';

-- 行程天表
CREATE TABLE itinerary_days (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    itinerary_id BIGINT NOT NULL COMMENT '行程ID',
    day_index INT NOT NULL COMMENT '第几天,从1开始',
    theme VARCHAR(100) DEFAULT NULL COMMENT '当日主题',
    notes VARCHAR(500) DEFAULT NULL COMMENT '当日备注/建议',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_itinerary_id (itinerary_id),
    CONSTRAINT fk_day_itinerary FOREIGN KEY (itinerary_id) REFERENCES itineraries(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='行程天表';

-- 行程项表
CREATE TABLE itinerary_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    day_id BIGINT NOT NULL COMMENT '行程天ID',
    poi_id BIGINT NOT NULL COMMENT 'POI ID',
    order_index INT NOT NULL COMMENT '当天顺序,从1开始',
    start_time VARCHAR(10) DEFAULT NULL COMMENT '建议开始时间',
    tips VARCHAR(500) DEFAULT NULL COMMENT '游玩建议',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_day_id (day_id),
    KEY idx_poi_id (poi_id),
    CONSTRAINT fk_item_day FOREIGN KEY (day_id) REFERENCES itinerary_days(id) ON DELETE CASCADE,
    CONSTRAINT fk_item_poi FOREIGN KEY (poi_id) REFERENCES pois(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='行程项表';

-- 路线缓存表
CREATE TABLE route_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    from_poi_id BIGINT NOT NULL COMMENT '起点POI ID',
    to_poi_id BIGINT NOT NULL COMMENT '终点POI ID',
    distance_meter INT DEFAULT NULL COMMENT '距离(米)',
    walk_duration_sec INT DEFAULT NULL COMMENT '步行时长(秒)',
    drive_duration_sec INT DEFAULT NULL COMMENT '驾车时长(秒)',
    transit_duration_sec INT DEFAULT NULL COMMENT '公交时长(秒)',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_from_to (from_poi_id, to_poi_id),
    KEY idx_to_poi (to_poi_id),
    CONSTRAINT fk_route_from_poi FOREIGN KEY (from_poi_id) REFERENCES pois(id) ON DELETE CASCADE,
    CONSTRAINT fk_route_to_poi FOREIGN KEY (to_poi_id) REFERENCES pois(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='路线缓存表';

-- 帖子表
CREATE TABLE posts (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    author_id BIGINT NOT NULL COMMENT '作者ID',
    itinerary_id BIGINT NOT NULL COMMENT '关联行程ID',
    title VARCHAR(100) NOT NULL COMMENT '标题',
    summary VARCHAR(500) DEFAULT NULL COMMENT '摘要',
    like_count INT NOT NULL DEFAULT 0 COMMENT '点赞数',
    favorite_count INT NOT NULL DEFAULT 0 COMMENT '收藏数',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '0下架 1正常',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_author_id (author_id),
    KEY idx_itinerary_id (itinerary_id),
    KEY idx_status_created (status, created_at DESC),
    KEY idx_status_like (status, like_count DESC),
    CONSTRAINT fk_post_author FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_post_itinerary FOREIGN KEY (itinerary_id) REFERENCES itineraries(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='帖子表';

-- 点赞表
CREATE TABLE likes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    post_id BIGINT NOT NULL COMMENT '帖子ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_post (user_id, post_id),
    KEY idx_post_id (post_id),
    CONSTRAINT fk_like_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_like_post FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点赞表';

-- 收藏表
CREATE TABLE favorites (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    post_id BIGINT NOT NULL COMMENT '帖子ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_post (user_id, post_id),
    KEY idx_post_id (post_id),
    CONSTRAINT fk_favorite_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_favorite_post FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

### 5.2 初始数据脚本 (init-data.sql)

```sql
USE trip_planner;

-- 插入管理员账号 (密码: admin123，BCrypt加密)
INSERT INTO users (username, email, password, role) VALUES
('admin', 'admin@trip.com', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', 'admin');

-- 插入示例POI数据（含AI标注字段）
INSERT INTO pois (name, lng, lat, address, city, area, tags, brief, visit_duration, best_time, highlights, suitable_for, tips, difficulty) VALUES
('大理古城', 100.1653, 25.6969, '云南省大理白族自治州大理市', '大理', '古城区',
 '["古镇", "摄影", "民族文化"]',
 '大理古城位于云南西部，是中国首批24个国家历史文化名城之一',
 180, '上午或傍晚，避开正午烈日',
 '["复兴路步行街", "洋人街", "五华楼"]',
 '["情侣", "家庭", "摄影爱好者"]',
 '建议从南门进入，沿复兴路漫步感受白族建筑风情', '轻松'),

('洱海', 100.1833, 25.7333, '云南省大理白族自治州大理市', '大理', '洱海周边',
 '["自然风光", "摄影"]',
 '洱海是云南第二大淡水湖，因其形状像人耳而得名',
 240, '日出或日落时分最美',
 '["环海公路", "洱海日出", "海鸥观赏"]',
 '["情侣", "摄影爱好者"]',
 '建议租车或电动车环海，可以随时停车拍照', '适中'),

('崇圣寺三塔', 100.1428, 25.7144, '云南省大理白族自治州大理市崇圣寺三塔文化旅游区', '大理', '古城区',
 '["摄影", "历史文化"]',
 '崇圣寺三塔是大理的标志性建筑，始建于南诏国时期',
 120, '傍晚光线最佳，可拍摄三塔倒影',
 '["三塔倒影", "崇圣寺", "南诏历史"]',
 '["情侣", "摄影爱好者", "历史文化爱好者"]',
 '建议傍晚前往拍摄三塔倒影，景区内有倒影池', '轻松'),

('双廊古镇', 100.1861, 25.9542, '云南省大理白族自治州大理市双廊镇', '大理', '双廊',
 '["古镇", "摄影", "网红打卡"]',
 '双廊位于洱海东北岸，被称为"苍洱风光第一镇"',
 180, '下午到傍晚，可看日落',
 '["洱海观景", "白族民居", "玉几岛"]',
 '["情侣", "摄影爱好者", "文艺青年"]',
 '建议住一晚体验洱海日出日落，玉几岛是必去打卡点', '轻松'),

('喜洲古镇', 100.1500, 25.8667, '云南省大理白族自治州大理市喜洲镇', '大理', '喜洲',
 '["古镇", "民族文化", "美食"]',
 '喜洲是白族聚居地，保存着大量明清时期的白族民居建筑',
 150, '上午游览，中午品尝喜洲粑粑',
 '["严家大院", "白族民居", "喜洲粑粑"]',
 '["家庭", "美食爱好者", "历史文化爱好者"]',
 '喜洲粑粑是必尝小吃，严家大院是最具代表性的白族民居', '轻松');
```

---

## 六、设计说明

### 6.1 设计决策

#### 为什么 route_cache 独立存储？

原计划中的 `route_legs` 表与行程天关联，会导致：
1. 相同的POI对在不同行程中重复存储
2. 无法实现跨行程的路线缓存复用

改为 `route_cache` 独立存储后：
1. 以 `from_poi_id + to_poi_id` 作为唯一键
2. 可被任意行程复用
3. 配合Redis缓存，实现多级缓存

#### 为什么删除 snapshot 字段？

原计划中 itineraries 表有 snapshot JSON 字段，存在问题：
1. 与 itinerary_days、itinerary_items 表数据冗余
2. 维护两份数据，容易不一致

改为完全依赖关联表存储行程详情。

#### 为什么增加 visit_duration 字段？

原计划中没有POI游玩时长，无法：
1. 合理估算一天能安排多少景点
2. 计算一天的总时间消耗

增加 `visit_duration` 字段后，算法可以更智能地安排行程。

### 6.2 扩展考虑

#### 6.2.1 预留扩展字段

以下字段将在后续版本添加，MVP阶段暂不实现：

**POI表扩展字段**

| 字段 | 类型 | 版本 | 用途 |
|-----|------|------|------|
| popularity_score | INT | v1.5 | 热度评分（0-100） |
| seasonal_tags | JSON | v1.5 | 季节性标签 |
| weather_suitable | JSON | v1.5 | 适合的天气类型 |
| crowd_level | JSON | v2.0 | 各时段拥挤程度 |
| user_rating | DECIMAL(3,2) | v2.0 | 用户评分统计 |
| booking_required | BOOLEAN | v2.0 | 是否需要预约 |

**用户表扩展字段**

| 字段 | 类型 | 版本 | 用途 |
|-----|------|------|------|
| preferences | JSON | v2.0 | 用户偏好画像 |
| travel_history | JSON | v2.0 | 历史行程摘要 |
| favorite_themes | JSON | v2.0 | 偏好主题 |

#### 6.2.2 后续版本新增表

| 表名 | 版本 | 用途 |
|-----|------|------|
| comments | v1.5 | 帖子评论 |
| follows | v1.5 | 用户关注关系 |
| user_behaviors | v2.0 | 用户行为记录（用于画像分析） |
| recommendation_logs | v2.0 | 推荐日志（用于算法优化） |

详细表结构请参考 [08-未来规划与扩展设计.md](./08-未来规划与扩展设计.md)

#### 6.2.3 功能扩展支持

1. **多城市扩展**：表结构已支持，只需增加其他城市的POI数据
2. **评论功能**：后续可增加 `comments` 表
3. **用户关注**：后续可增加 `follows` 表
4. **行程编辑**：当前表结构已支持修改 itinerary_items
